!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=68)}({1:function(e,t,o){"use strict";var n=o(2),r=o(5),a=o(4),i=o(10),s=o(8),c=o(14),u=o(21),d=o(9),p=o(7),l=o(6),w=o(13);const g={};window.GroupManager=g,g.setTabIsHidden=function(e,t,o=g.groups){const n=o.map(e=>e.tabs).reduce((e,t)=>e.concat(t),[]).filter(t=>t.id===e);n.length>0&&(n[0].hidden=t)},g.EVENT_PREPARE="groups-prepare",g.EVENT_CHANGE="groups-change",g.eventlistener=new u.a,g.repeatedtask=new c.a.RepeatedTask(5e3),g.checkerInterval=void 0,g.Group=function({id:e=-1,title:t="",tabs:o=[],windowId:n=browser.windows.WINDOW_ID_NONE,incognito:r=!1}={}){this.title=t,this.tabs=o.map(e=>d.a.getTabFactory(e)),this.id=e,this.windowId=n,this.index=-1,this.position=-1,this.expand=!1,this.lastAccessed=0,this.incognito=r},g.getGroupIdInWindow=function(e,{error:t=!0}={}){if(e!==browser.windows.WINDOW_ID_NONE)for(let t of g.groups)if(t.windowId===e)return t.id;const o="Failed to find group in window";if(t)throw Error(o+" "+e);return a.a.warning(o,{args:arguments}),-1},g.getGroupIndexFromGroupId=function(e,{error:t=!0,groups:o=g.groups}={}){for(let t=0;t<o.length;t++)if(o[t].id===e)return t;if(t)throw Error("GroupManager.getGroupIndexFromGroupId: Failed to find group index for id:  "+e);return-1},g.getGroupIndexFromWindowId=function(e,{error:t=!0}={}){for(let t=0;t<g.groups.length;t++)if(g.groups[t].windowId===e)return t;if(t)throw Error("GroupManager.getGroupIndexFromWindowId: Failed to find group index for id:  "+e);return-1},g.getGroupIdFromTabId=function(e,{error:t=!1}={}){for(let t=0;t<g.groups.length;t++)for(let o=0;o<g.groups[t].tabs.length;o++)if(g.groups[t].tabs[o].id===e)return g.groups[t].id;if(t)throw Error("GroupManager.getGroupIdFromTabId: Failed to find group id for tab id:  "+e);return-1},g.getTabIndexFromTabId=function(e,t,{error:o=!1}={}){for(let o=0;o<g.groups[t].tabs.length;o++)if(g.groups[t].tabs[o].id===e)return o;if(o)throw Error("GroupManager.getTabIndexFromTabId: Failed to find tab index for tab id:  "+e+" in group id "+g.groups[t].id);return-1},g.getWindowIdFromGroupId=function(e){for(let t=0;t<g.groups.length;t++)if(g.groups[t].id===e&&g.groups[t].windowId!==browser.windows.WINDOW_ID_NONE)return g.groups[t].windowId;throw Error("GroupManager.getWindowIdFromGroupId: Failed to find opened window for id:  "+e)},g.getGroupFromGroupId=function(e,{groups:t=g.groups,copy:o=!1,error:r=!0}={}){const a=g.getGroupIndexFromGroupId(e,{groups:t,error:r});if(a>-1&&a<t.length)return o?n.a.getCopy(t[a]):t[a];if(r)throw Error("GroupManager.getGroupFromGroupId: Failed to find group index for id:  "+e);return null},g.isWindowAlreadyRegistered=function(e){if(e===browser.windows.WINDOW_ID_NONE)return!1;for(let t of g.groups)if(t.windowId===e)return!0;return!1},g.getCopy=function(){return JSON.parse(JSON.stringify(g.groups))},g.coherentActiveTabInGroups=function({groups:e=g.groups}={}){for(let t=0;t<e.length;t++){if(!e[t].tabs.length)continue;let o=e[t].tabs.map((e,t)=>e.active?t:-1).filter(e=>e>=0);if(o.length||(e[t].tabs[e[t].tabs.length-1].active=!0),o.length>1)for(let n=1;n<o.length;n++)e[t].tabs[o[n]].active=!1}},g.changeExpandState=function(e,t,{groups:o=g.groups}={}){try{e.forEach(e=>{let n=g.getGroupIndexFromGroupId(e,{error:!0,groups:o});o[n].expand=t}),g.eventlistener.fire(g.EVENT_PREPARE)}catch(e){a.a.error(e,{args:arguments})}},g.changeGroupPosition=function(e,t,{groups:o=g.groups,allow:n=r.a.options.groups.sortingType===l.a.SORT_CUSTOM}={}){try{let n=g.getGroupIndexFromGroupId(e,{error:!0,groups:o}),r=o[n].position;if(r===t||t===r+1)return;if(r>t)for(let e of o)e.position>=t&&e.position<r&&e.position++;else if(t>r){t--;for(let e of o)e.position>r&&e.position<=t&&e.position--}o[n].position=t,g.eventlistener.fire(g.EVENT_PREPARE)}catch(e){a.a.error(e,{args:arguments})}},g.setAllPositions=function({groups:e=g.groups,sortingType:t=r.a.options.groups.sortingType}={}){if(g.coherentPositionInGroups(e),t===l.a.SORT_CUSTOM)return;let o=[];t===l.a.SORT_OLD_RECENT&&(o=[...Array(e.length).keys()]),t===l.a.SORT_RECENT_OLD&&(o=[...Array(e.length).keys()].reverse()),t===l.a.SORT_ALPHABETICAL&&(o=g.sortGroupsAlphabetically(e)),t===l.a.SORT_LAST_ACCESSED&&(o=g.sortGroupsLastAccessed(e));for(let t=0;t<e.length;t++)e[t].position=o[t]},g.setLastAccessed=function(e,t,{groups:o=g.groups}={}){try{o[g.getGroupIndexFromGroupId(e,{error:!0,groups:o})].lastAccessed=t,g.eventlistener.fire(g.EVENT_PREPARE)}catch(e){a.a.error(e,{args:arguments})}},g.updateLastAccessedFromTabs=function(e=g.groups){for(let t of e){let e=t.lastAccessed;for(let o of t.tabs)null!=o.lastAccessed&&o.lastAccessed>e&&(e=o.lastAccessed);t.lastAccessed=e}},g.setAllIndexes=function(e=g.groups){let t=0;for(let o of e)o.index=t,t++},g.setTabsInGroupId=function(e,t){try{let o=g.getGroupIndexFromGroupId(e);g.groups[o].tabs=n.a.getCopy(t),g.eventlistener.fire(g.EVENT_PREPARE)}catch(e){a.a.error(e,{args:arguments})}},g.attachWindowWithGroupId=async function(e,t){let o;try{o=g.getGroupIndexFromGroupId(e),g.groups[o].windowId=t,await s.a.associateGroupIdToWindow(t,e),await d.a.updateTabsInGroup(t),g.eventlistener.fire(g.EVENT_CHANGE)}catch(e){a.a.error(e,{args:arguments})}},g.check_integrity=function(e){let t=new g.Group;for(let o of e)n.a.mergeObject(o,t);return e},g.detachWindowFromGroupId=async function(e){try{const t=g.getWindowIdFromGroupId(e);await g.detachWindow(t)}catch(e){a.a.error(e,{args:arguments})}},g.removeAllGroups=function(e=g.groups){n.a.isDeadObject(e)?g.groups=[]:e.length=0,g.eventlistener.fire(g.EVENT_PREPARE)},g.reloadGroupsFromDisk=async function(){g.groups=await p.a.Local.loadGroups(),g.eventlistener.fire(g.EVENT_PREPARE)},g.detachWindow=async function(e,{fireEvent:t=!0}={}){let o;try{if(-1===(o=g.getGroupIndexFromWindowId(e,{error:!1})))return"GroupManager.detachWindow done because no group was in window: "+e;g.groups[o].windowId=browser.windows.WINDOW_ID_NONE,g.groups[o].incognito?await g.removeGroupFromId(g.groups[o].id):await s.a.desassociateGroupIdToWindow(e),t&&g.eventlistener.fire(g.EVENT_PREPARE)}catch(e){a.a.error(e,{args:arguments})}},g.removeGroupsInPrivateWindow=async function(e=g.groups){try{for(let t=e.length-1;t>=0;t--)e[t].tabs.length>0&&e[t].tabs[0].incognito&&!r.a.options.privateWindow.sync&&await g.removeGroupFromId(e[t].id);return"GroupManager.removeGroupsInPrivateWindow done!"}catch(e){a.a.error(e,{args:arguments})}},g.removeGroupFromId=async function(e){let t;try{t=g.getGroupIndexFromGroupId(e),g.groups[t].windowId!==browser.windows.WINDOW_ID_NONE&&await s.a.desassociateGroupIdToWindow(g.groups[t].windowId),g.groups.splice(t,1),g.eventlistener.fire(g.EVENT_PREPARE)}catch(e){a.a.error(e,{args:arguments})}},g.removeTabFromIndexInGroupId=async function(e,t,{changeBrowser:o=!0,fireEvent:n=!0}={}){let r;try{if(r=g.getGroupIndexFromGroupId(e),g.groups[r].tabs.length<=t)throw Error("GroupManager.removeTabFromIndexInGroupId impossible");return g.isGroupIndexInOpenWindow(r)&&o?await browser.tabs.remove([g.groups[r].tabs[t].id]):g.groups[r].tabs.splice(t,1),n&&g.eventlistener.fire(g.EVENT_PREPARE),"GroupManager.removeTabFromIndexInGroupId done!"}catch(e){a.a.error(e,{args:arguments})}},g.moveTabBetweenGroups=async function(e,t,o,n,r=-1){await g.addTabInGroupId(n,e,{targetIndex:r,fireEvent:!1}),await g.removeTabFromIndexInGroupId(t,o,{changeBrowser:!0,fireEvent:!1}),g.eventlistener.fire(g.EVENT_PREPARE)},g.addTabInGroupId=async function(e,t,{targetIndex:o=-1,fireEvent:n=!0}={}){let r;try{if(r=g.getGroupIndexFromGroupId(e),g.isGroupIndexInOpenWindow(r)){const e=await d.a.openListOfTabs([t],g.groups[r].windowId,{inLastPos:!0});await d.a.moveOpenTabToGroup(e[0],g.groups[r].windowId,o)}else{let e=d.a.secureIndex(o,t,g.groups[r].tabs);g.groups[r].tabs.splice(e,0,t)}return n&&g.eventlistener.fire(g.EVENT_PREPARE),"GroupManager.addTabInGroupId done!"}catch(e){a.a.error(e,{args:arguments})}},g.updateAllOpenedGroups=async function(){for(let e of g.groups)e.windowId!==browser.windows.WINDOW_ID_NONE&&await d.a.updateTabsInGroup(e.windowId)},g.renameGroup=function(e,t){g.groups[e].title=t,g.groups[e].windowId!==browser.windows.WINDOW_ID_NONE&&s.a.setWindowPrefixGroupTitle(g.groups[e].windowId,g.groups[e]),g.eventlistener.fire(g.EVENT_PREPARE)},g.addGroup=function({title:e="",windowId:t=browser.windows.WINDOW_ID_NONE,incognito:o=!1}={}){if(g.isWindowAlreadyRegistered(t))return;let n,r=[{url:w.a.NEW_TAB,title:"New Tab",active:!0}];try{n=g.createUniqueGroupId(),g.groups.push(new g.Group({id:n,title:e,tabs:r,windowId:t,incognito:o}))}catch(e){throw Error("addGroup: Group not created because "+e)}return g.eventlistener.fire(g.EVENT_PREPARE),n},g.addGroupWithTab=function(e,{windowId:t=browser.windows.WINDOW_ID_NONE,title:o="",incognito:n=!1}={}){if(0===e.length)return g.addGroup({title:o,windowId:t,incognito:n});let r;try{r=g.createUniqueGroupId(),g.groups.push(new g.Group({id:r,title:o,tabs:e,windowId:t,incognito:n}))}catch(e){throw Error("addGroupWithTab: Group not created because "+e.message)}return g.eventlistener.fire(g.EVENT_PREPARE),r},g.addGroups=function(e,{groups:t=g.groups,showNotification:o=!1}={}){let r=[];for(let o of e)o.id=g.createUniqueGroupId(t),o.windowId=browser.windows.WINDOW_ID_NONE,r.push(o.id),t.push(n.a.getCopy(o));return o&&browser.notifications.create({type:"basic",iconUrl:browser.extension.getURL("/share/icons/tabspace-active-64.png"),title:"Import Groups succeeded",message:e.length+" groups imported.",eventTime:4e3}),g.eventlistener.fire(g.EVENT_PREPARE),r},g.filterGroups=function(e,t){if(void 0===t)return e;let o=[];for(let r of e)if(t.hasOwnProperty(r.id)&&t[r.id].selected>0){let e=n.a.getCopy(r);e.tabs=e.tabs.filter((e,o)=>t[r.id].tabs[o]),o.push(e)}return o},g.resetAssociatedWindows=function({fireEvent:e=!0}={}){for(let e of g.groups)e.windowId=browser.windows.WINDOW_ID_NONE;e&&g.eventlistener.fire(g.EVENT_CHANGE)},g.removeUnopenGroups=function(){for(let e=g.groups.length-1;e>=0;e--)g.groups[e].windowId===browser.windows.WINDOW_ID_NONE&&g.groups.splice(e,1);g.eventlistener.fire(g.EVENT_PREPARE)},g.removeEmptyGroup=function({fireEvent:e=!0,groups:t=g.groups}={}){for(let e=t.length-1;e>=0;e--)0===t[e].tabs.length&&t.splice(e,1);e&&g.eventlistener.fire(g.EVENT_PREPARE)},g.isGroupIndexInOpenWindow=function(e){return g.groups[e].windowId!==browser.windows.WINDOW_ID_NONE},g.createUniqueGroupId=function(e=g.groups){let t=e.length-1,o=!0,n=0;do{t++,n++,o=!0;for(let n of e)o=o&&n.id!==t;if(n>1e5)throw Error("createUniqueGroupId: Can't find an unique group Id")}while(!o);return t},g.init=async function(){try{let e=await p.a.Local.loadGroups();g.groups=g.check_integrity(e);const t=[];for(let e=0;e<g.groups.length;e++){-1!==g.groups[e].windowId&&t.push(e)}g.resetAssociatedWindows({fireEvent:!1}),await g.integrateAllOpenedWindows();for(let e of t){const t=g.groups[e];-1===t.windowId&&browser.notifications.create(null,{type:"basic",iconUrl:browser.extension.getURL("/share/icons/tabspace-active-64.png"),title:"Fail to find the window",message:`For the group previously opened named "${n.a.getGroupTitle(t)}".You might check your groups to avoid data loss.`})}return g.initGroupManagerEventListener(),g.eventlistener.fire(g.EVENT_PREPARE),"GroupManager.init done"}catch(e){a.a.error(e,{args:arguments})}},g.integrateAllOpenedWindows=async function(){const e=await browser.windows.getAll();for(let t of e)try{await s.a.integrateWindow(t.id,{even_new_one:!!i.a.install})}catch(e){a.a.error(e)}},g.store=function(){g.checkCorruptedGroups(g.groups)?a.a.information("Corrupted groups, saved not done."):p.a.Local.saveGroups(g.getCopy())},g.initGroupManagerEventListener=function(){g.eventlistener.on(g.EVENT_CHANGE,()=>{g.repeatedtask.add(()=>{g.store()})}),g.eventlistener.on(g.EVENT_PREPARE,()=>{g.prepareGroups(g.groups),g.eventlistener.fire(g.EVENT_CHANGE)}),g.checkerInterval=setInterval(()=>{g.checkCorruptedGroups(g.groups)},3e4)},g.prepareGroups=function(e=g.groups,{removeEmptyGroup:t=r.a.options.groups.removeEmptyGroup}={}){try{t&&g.removeEmptyGroup({groups:e,fireEvent:!1}),g.setAllIndexes(e),g.setAllPositions({groups:e,sortingType:r.a.options.groups.sortingType}),g.coherentActiveTabInGroups({groups:e}),g.setUniqueTabIds(e)}catch(e){a.a.error(e)}},g.getUniqueTabId=function(e,t){return Date.now()+"-"+e+"-"+t},g.setUniqueTabIds=function(e=g.groups){e.forEach(e=>{if(!0===s.a.GROUP_CURRENTLY_SWITCHING[e.id])return;if(-1!==e.windowId)return;let t={};e.tabs.forEach((o,r)=>{if(!(n.a.hasHideFunction()&&!0===o.hidden||o.id&&o.id.length)){let n=o.id;o.id=g.getUniqueTabId(e.id,r),t[n]=o.id}}),e.tabs.forEach((e,o)=>{void 0!==e.openerTabId&&t.hasOwnProperty(e.openerTabId)&&(e.openerTabId=t[e.openerTabId])})})},g.checkCorruptedTab=function(e,t){const o={title:"Title lost, you need to reopen the tab",url:null,pinned:!1,windowId:browser.windows.WINDOW_ID_NONE,active:!1};return(n.a.hasDiscardFunction()||n.a.isFF57())&&(o.discarded=!1),n.a.isFirefox()&&(o.lastAccessed=0),n.a.hasHideFunction()&&(o.hidden=!1),n.a.ojectPropertiesAreUndefined(e,o,`tabs[${t}]`)},g.checkCorruptedTabs=function(e,t){const o=e.map(g.checkCorruptedTab).filter(([e,t])=>t.length>0);return 0===o.length?[!1,""]:[o.filter(([e,t])=>e).length>0,o.map(([e,o])=>o.map(e=>`${t}.${e}`).join(",")).join(",")]},g.checkCorruptedGroup=function(e,t){const o=`GroupManager.groups[${t}]`,r=n.a.ojectPropertiesAreUndefined(e,{title:"",tabs:null,id:Math.floor(100*Math.random())+500*t,windowId:browser.windows.WINDOW_ID_NONE,expand:!1,lastAccessed:0,incognito:!1},o);if(e&&null!=e.tabs){const t=g.checkCorruptedTabs(e.tabs,o);r[0]=r[0]||t[0],t[1].length>0&&r[1].push(t[1])}return 0===r[1].length?[!1,""]:[r[0],r[1].join(",")]},g.checkCorruptedGroupsArray=function(e){if(null!=e){const t=e.map(g.checkCorruptedGroup).filter(([e,t])=>t.length>0);return[t.filter(([e,t])=>e).length>0,t.map(([e,t])=>t).join(",")]}return[!0,"GroupManager.groups"]},g.checkCorruptedGroups=function(e=g.groups,{shouldBefixed:t=!0,withMessage:o=!1}={}){let r=!1,i="";return n.a.isDeadObject(e)?(r=!0,i="Groups are dead"):[r,i]=g.checkCorruptedGroupsArray(e),r?(a.a.error(`Sync Tab Groups has detected a corruption in your groups: ${i}`),!n.a.DEBUG_MODE&&t&&(g.reloadGroupsFromDisk(),a.a.information("Tried to correct groups corruption..."))):i.length>0&&a.a.information(`Sync Tab Groups has detected a corruption in your groups and fixed it: ${i}`),o?[r,i]:r},g.sortGroupsLastAccessed=function(e=g.groups){let t=[],o=[];return e.forEach(e=>{o.push({lastAccessed:e.lastAccessed,id:e.id,title:e.title,index:e.index})}),o.sort((e,t)=>e.lastAccessed===t.lastAccessed?""===e.title&&""===t.title?e.id<t.id?-1:1:e.title===t.title?e.id<t.id?-1:1:""===e.title?1:""===t.title?-1:e.title<t.title?-1:1:e.lastAccessed<t.lastAccessed?1:-1),o.forEach((e,o)=>{t[e.index]=o}),t},g.sortGroupsAlphabetically=function(e=g.groups){let t=[],o=[];return e.forEach(e=>{o.push({title:e.title,id:e.id,index:e.index})}),o.sort((e,t)=>""===e.title&&""===t.title?e.id<t.id?-1:1:e.title===t.title?e.id<t.id?-1:1:""===e.title?1:""===t.title?-1:e.title<t.title?-1:1),o.forEach((e,o)=>{t[e.index]=o}),t},g.getGroupsWithoutPrivate=function(e=g.groups){return e.filter(e=>!e.incognito)},g.coherentPositionInGroups=function(e=g.groups){let t=[];for(let t of[...Array(e.length).keys()]){let o=!1;for(let n of e)if(n.position===t){o=!0;break}if(!o)for(let o of e)o.position>t&&o.position--}e.forEach(e=>{e.position>=0&&(t[e.position]?e.position=-1:t[e.position]=!0)});for(let o of[...Array(e.length).keys()])if(!t[o])for(let t of e)if(-1===t.position){t.position=o;break}},g.compareTabs=function(e,t){if(e.length!==t.length)return!1;for(let o=0;o<e.length;o++){if(e[o].url!==t[o].url)return!1;if(e[o].pinned!==t[o].pinned)return!1}return!0},g.bestMatchGroup=function(e,t=g.groups){let o=browser.runtime.getURL(""),r=(t=t.filter(t=>e.length&&e[0].incognito===t.incognito)).filter(t=>g.compareTabs(e,t.tabs));if(!r.length){let a=n.a.getCopy(e).filter(e=>!n.a.extractTabUrl(e.url).includes(o));r=t.filter(e=>{let t=n.a.getCopy(e.tabs).filter(e=>!n.a.extractTabUrl(e.url).includes(o));return g.compareTabs(a,t)})}return r.length>1&&(r=[r=r.reduce((e,t)=>e.lastAccessed>=t.lastAccessed?e:t)]),r.length?r[0].id:-1},t.a=g},10:function(e,t,o){"use strict";var n=o(4),r=o(2),a=o(14),i=o(7),s=o(9),c=o(5),u=o(1),d=o(8),p=o(19),l=o(15),w=o(18),g=o(11);a.a.fromUI={[g.a.CLOSE_REFERENCE]:new a.a.DelayedTask,[g.a.REMOVE_REFERENCE]:new a.a.DelayedTask};const f={};window.BackgroundHelper=f,f.refreshOptionsUI=function(){r.a.sendMessage("Option:Changed",{options:c.a.options})},f.refreshBackupListUI=async function(){r.a.sendMessage("BackupList:Changed",{backupList:await i.a.Local.getBackUpList()})},f.refreshUi=function(){r.a.sendMessage("Groups:Changed",{groups:u.a.groups,delayedTasks:a.a.fromUI})},f.onRemoveHiddenTab=function({tabId:e}){l.a.closeHiddenTabs(e)},f.onRemoveHiddenTabsInGroup=function({groupId:e}){const t=u.a.getGroupIndexFromGroupId(e),o=u.a.groups[t].tabs.map(({id:e})=>e);l.a.closeHiddenTabs(o)},f.onOpenGroupInNewWindow=function({groupId:e}){d.a.selectGroup(e,{newWindow:!0})},f.onOpenGuide=function(){r.a.openUrlOncePerWindow("https://morikko.github.io/synctabgroups/#guide")},f.onGroupAdd=function({title:e}){try{u.a.addGroup({title:e})}catch(e){n.a.error(e)}},f.onGroupAddWithTab=function({title:e,sourceGroupId:t,tabIndex:o}){s.a.moveTabToNewGroup(t,o,e)},f.onGroupClose=function({groupId:e,taskRef:t}){a.a.fromUI[g.a.CLOSE_REFERENCE].manage(t,async()=>{try{return await d.a.closeGroup(e,{close_window:!1}),f.refreshUi(),"Background.onGroupClose done!"}catch(e){n.a.error(e)}},e)},f.onGroupRemove=async function({groupId:e,taskRef:t}){return new Promise((o,n)=>{a.a.fromUI[g.a.REMOVE_REFERENCE].manage(t,async()=>{await d.a.removeGroup(e),o()},e)})},f.onGroupRename=function({groupId:e,title:t}){u.a.renameGroup(u.a.getGroupIndexFromGroupId(e),t)},f.onGroupSelect=function({groupId:e}){d.a.selectGroup(e,{newWindow:!1})},f.onTabSelect=function({tabIndex:e,groupId:t,newWindow:o}){s.a.selectTab(e,t,o)},f.onMoveTabToGroup=async function({sourceGroupId:e,sourceTabIndex:t,targetGroupId:o,targetTabIndex:n}){await s.a.moveTabBetweenGroups(e,t,o,n)},f.onBookmarkSave=function(){i.a.Bookmark.backUp(u.a.getCopy(),!0)},f.onOpenSettings=function(e=!0){r.a.openUrlOncePerWindow(browser.extension.getURL("/options/option-page.html"),e)},f.onRemoveAllGroups=function(){u.a.removeAllGroups()},f.onReloadGroups=function(){u.a.reloadGroupsFromDisk()},f.changeSynchronizationStateOfWindow=async function(e){const{isSync:t,windowId:o,title:r=""}=e;try{if(t)await d.a.integrateWindow(o,{even_new_one:!0,title:r});else try{let e=u.a.getGroupIdInWindow(o);u.a.removeGroupFromId(e)}catch(e){n.a.error(e,{isSync:t,windowId:o})}}catch(e){n.a.error(e,{args:arguments})}},f.onTabClose=async function({groupId:e,tabIndex:t}){try{await u.a.removeTabFromIndexInGroupId(e,t)}catch(e){n.a.error(e)}},f.onTabOpen=async function({tab:e}){try{const t=await browser.windows.getLastFocused();await s.a.openListOfTabs([e],t.id,{inLastPos:!0})}catch(e){n.a.error(e)}},f.onImportGroups=function({content_file:e,filename:t}){p.a.onOpenGroupsSelector({title:"From file: "+t,groups:i.a.File.importGroupsFromFile(e),type:w.a.IMPORT})},f.onExportGroups=function(){p.a.onOpenGroupsSelector({title:"Current groups at "+new Date,groups:u.a.getCopy(),type:w.a.EXPORT})},f.onExportBackUp=async function(e){p.a.onOpenGroupsSelector({title:"Back up: "+i.a.Local.getBackUpDate(e),groups:await i.a.Local.getBackUp(e),type:w.a.EXPORT})},f.onImportBackUp=async function(e){p.a.onOpenGroupsSelector({title:"Back up: "+i.a.Local.getBackUpDate(e),groups:await i.a.Local.getBackUp(e),type:w.a.IMPORT})},f.onRemoveBackUp=async function(e){await i.a.Local.removeBackup(e)},f.onGroupChangePosition=async function({groupId:e,position:t}){await u.a.changeGroupPosition(e,t)},f.onTabChangePin=async function({groupId:e,tabIndex:t}){await s.a.changePinState(e,t)},f.onChangeExpand=function({groupId:e,expand:t}){u.a.changeExpandState(e,t)},f.refreshData=function({all_tabs:e=!1}={}){e?f.sendAllTabs():f.refreshUi(),f.refreshOptionsUI()},f.sendAllTabs=async function(){const e=(await browser.windows.getAll({populate:!0})).map((e,t)=>new u.a.Group({id:t,title:"Window "+e.id,tabs:e.tabs,windowId:e.id,incognito:e.incognito}));r.a.sendMessage("Tabs:All",{groups:e})},f.updateNotificationId="UPDATE_NOTIFICATION",f.lastVersion=null,f.install=null,t.a=f},11:function(e,t,o){"use strict";const n={ASK:"ASK",CANCEL:"CANCEL",FORCE:"FORCE",CLOSE_REFERENCE:"close",REMOVE_REFERENCE:"remove"};t.a=n},13:function(e,t,o){"use strict";const n={NEW_TAB:(()=>null==browser.runtime.getBrowserInfo)()?"chrome://newtab/":"about:newtab"};t.a=n},14:function(e,t,o){"use strict";var n=o(11);const r=function(e=1e4){this.delayedTasks={},this.timeoutDelay=e};r.prototype.manage=async function(e,t,o=0){switch(e){case n.a.ASK:this.add(t,o);break;case n.a.CANCEL:this.remove(o);break;case n.a.FORCE:this.remove(o),await t()}},r.prototype.add=async function(e,t=0){this.remove(t),this.delayedTasks[t]=setTimeout(async()=>{await e(),this.remove(t)},this.timeoutDelay)},r.prototype.remove=function(e=0){void 0!==this.delayedTasks[e]&&(clearTimeout(this.delayedTasks[e]),delete this.delayedTasks[e],this.queuing=!1)};var a=r,i=o(4);const s=function(e=1e4){this.delayedTasks={},this.timeoutDelay=e,this.queuing=!1};s.prototype.add=async function(e,t=!1,o=0){try{if(void 0===this.delayedTasks[o]||this.delayedTasks[o]>=0&&t){this.delayedTasks[o]>=0&&t&&this.remove(o),this.delayedTasks[o]=-1;let n=performance.now();await e();let r=performance.now()-n,a=this.timeoutDelay-r;a=a<0?0:a,this.delayedTasks[o]=setTimeout(async()=>{this.queuing?(this.queuing=!1,this.remove(o),this.add(e)):this.remove(o)},a)}else this.queuing=!0}catch(e){this.remove(o),i.a.error(e,{args:arguments})}},s.prototype.remove=function(e=0){void 0!==this.delayedTasks[e]&&(clearTimeout(this.delayedTasks[e]),delete this.delayedTasks[e],this.queuing=!1)};const c={DelayedTask:a,RepeatedTask:s};window.TaskManager=c;t.a=c},15:function(e,t,o){"use strict";var n=o(2),r=o(4),a=o(5),i=o(1),s=o(6);const c={};window.TabHidden=c,c.TABHIDDEN_SESSION_KEY="TABHIDDEN_ID",c.cleaningUnknownHiddenTabsProcess=null,c.showTab=async function(e,t,o=-1){if("string"==typeof e)return!1;try{return await browser.tabs.move(e,{windowId:t,index:o}),await browser.tabs.show(e),browser.sessions.removeTabValue(e,c.TABHIDDEN_SESSION_KEY),!0}catch(e){return n.a.DEBUG_MODE&&(e.message="Impossible to show tab: "+e.message,r.a.warning(e.message,{args:arguments})),!1}},c.hideTab=async function(e){try{const t=await browser.tabs.hide(e);return 0!==t.length&&(a.a.options.groups.discardedHide&&setTimeout(async function(){try{await browser.tabs.discard(e)}catch(e){r.a.warning(e.message,{args:arguments})}},2e3),browser.sessions.setTabValue(e,c.TABHIDDEN_SESSION_KEY,e)),0!==t.length}catch(e){return r.a.warning(e.message,{args:arguments}),!1}},c.closeAllHiddenTabsInGroups=async function(e=i.a.groups){const t=async function(e){try{await browser.tabs.remove(e.id)}catch(e){r.a.error(e)}e.hidden=!1};await Promise.all(e.map(async function(e){return Promise.all(e.tabs.filter(e=>e.hidden).map(t))})),i.a.eventlistener.fire(i.a.EVENT_PREPARE)},c.changeHiddenStateForTab=function(e,t=!1){const o=i.a.getGroupIdFromTabId(e,{error:!1});if(-1===o)return!1;const n=i.a.getGroupIndexFromGroupId(o,{error:!1});if(-1===n)return!1;const r=i.a.getTabIndexFromTabId(e,n,{error:!1});return-1!==r&&(i.a.groups[n].tabs[r].hidden=t,!0)},c.closeHiddenTabs=async function(e){Array.isArray(e)||(e=[e]);try{await browser.tabs.remove(e)}catch(e){r.a.error(e,{args:arguments})}e.forEach(c.changeHiddenStateForTab),i.a.eventlistener.fire(i.a.EVENT_PREPARE)},c.removeAllHiddenTabs=async function(){const e=(await browser.tabs.query({})).filter(({hidden:e})=>e).map(({id:e})=>e);await c.closeHiddenTabs(e)},c.onStartInitialization=async function(){if(a.a.options.groups.closingState===s.a.CLOSE_HIDDEN)try{const e=(await browser.tabs.query({hidden:!0})).map(({id:e})=>e),t={};await Promise.all(e.map(async e=>{const o=await browser.sessions.getTabValue(e,c.TABHIDDEN_SESSION_KEY);if(null==o)return;const n=parseInt(o),r=i.a.getGroupIdFromTabId(n,{error:!1});if(-1===r)return;const a=i.a.getGroupIndexFromGroupId(r,{error:!1});if(-1===a)return;const s=i.a.getTabIndexFromTabId(n,a,{error:!1});-1!==s&&(i.a.groups[a].tabs[s].id=e,t[e]=!0)})),i.a.groups.forEach(({tabs:e})=>{e.forEach(e=>{e.hidden&&null==t[e.id]&&(e.hidden=!1)})}),i.a.eventlistener.fire(i.a.EVENT_PREPARE)}catch(e){r.a.error(e)}},c.closeUnknownHiddenTabs=async function(){try{const e=(await browser.tabs.query({hidden:!0})).map(({id:e})=>e);await Promise.all(e.map(async e=>{if(!(i.a.getGroupIdFromTabId(e,{error:!1})>-1))try{await browser.tabs.remove(e)}catch(e){r.a.error(e)}}))}catch(e){r.a.error(e)}},c.startCleaningUnknownHiddenTabsProcess=async function({doItNow:e=!1}={}){a.a.options.groups.removeUnknownHiddenTabs&&(e&&await c.closeUnknownHiddenTabs(),c.cleaningUnknownHiddenTabsProcess=setInterval(c.closeUnknownHiddenTabs,12e4))},c.stopCleaningUnknownHiddenTabsProcess=function(){c.cleaningUnknownHiddenTabsProcess&&(clearInterval(c.cleaningUnknownHiddenTabsProcess),c.cleaningUnknownHiddenTabsProcess=null)},t.a=c},18:function(e,t,o){"use strict";const n=Object.freeze({EXPORT:"Export",IMPORT:"Import"});t.a=n},19:function(e,t,o){"use strict";var n=o(2),r=o(1),a=o(18);const i={};window.ImportSelector=i,i.WINDOW_ID=browser.windows.WINDOW_ID_NONE,i.type=a.a.IMPORT,i.groups=[],i.file="No groups selected",i.onOpenGroupsSelector=async function({title:e=i.file,groups:t=[],type:o=a.a.IMPORT,force:s=!1}={}){if(0===t.length&&!s)return void browser.notifications.create({type:"basic",iconUrl:browser.extension.getURL("/share/icons/tabspace-active-64.png"),title:o+" "+e,message:"The group list was empty...",eventTime:4e3});if(r.a.checkCorruptedGroups(t))return void browser.notifications.create({type:"basic",iconUrl:browser.extension.getURL("/share/icons/tabspace-active-64.png"),title:o+" "+e,message:"The group list is corrupted... It is impossible to load it.",eventTime:4e3});const c=n.a.SELECTOR_PAGE_URL+"?title="+o+" "+e+"&type="+o,u=browser.extension.getURL(c);let d=window.screen.availHeight-100;const p={height:d,width:Math.min(window.screen.availWidth,850),top:50,left:Math.round((window.screen.availWidth-Math.min(window.screen.availWidth,850))/2)};if(i.groups=r.a.getGroupsWithoutPrivate(t.filter(e=>e.tabs.length)),r.a.prepareGroups(i.groups),i.type=o,i.WINDOW_ID===browser.windows.WINDOW_ID_NONE)p.url=u,p.type="popup",i.WINDOW_ID=(await browser.windows.create(p)).id,await browser.windows.update(i.WINDOW_ID,{height:d-1});else{const e=await browser.tabs.query({windowId:i.WINDOW_ID,index:0});await browser.tabs.update(e[0].id,{url:u}),p.focused=!0,await browser.windows.update(i.WINDOW_ID,p)}},i.wasClosedGroupsSelector=function(e){e===i.WINDOW_ID&&e!==browser.windows.WINDOW_ID_NONE&&(i.WINDOW_ID=browser.windows.WINDOW_ID_NONE)},i.closeGroupsSelector=async function(){if(i.WINDOW_ID!==browser.windows.WINDOW_ID_NONE)try{await browser.windows.remove(i.WINDOW_ID)}catch(e){return}finally{i.WINDOW_ID=browser.windows.WINDOW_ID_NONE}},t.a=i},2:function(e,t,o){"use strict";var n=o(13);const r={};window.Utils=r,r.DEBUG_MODE=!1,r.UTILS_SHOW_MESSAGES=r.DEBUG_MODE,r.PRIV_PAGE_URL="/tabpages/privileged-tab/privileged-tab.html",r.LAZY_PAGE_URL="/tabpages/lazytab/lazytab.html",r.SELECTOR_PAGE_URL="tabpages/selector-groups/selector-groups.html",r.setObjectPropertiesWith=function(e,t){let o=r.getCopy(e);for(let e in o)o[e]=t;return o},r.mergeObject=function(e,t){for(let o in t)e.hasOwnProperty(o)||(e[o]=t[o]),"object"==typeof t[o]&&r.mergeObject(e[o],t[o]);return e},r.getCopy=function(e){return JSON.parse(JSON.stringify(e))},r.setBrowserActionIcon=function(e){!0===e?browser.browserAction.setIcon({path:{16:"/share/icons/tabspace-light-16.png",32:"/share/icons/tabspace-light-32.png"}}):!1===e&&browser.browserAction.setIcon({path:{16:"/share/icons/tabspace-16.png",32:"/share/icons/tabspace-32.png"}})},r.getParameterByName=function(e,t){t||(t=window.location.href),e=e.replace(/[[\]]/g,"\\$&");let o=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return o&&o[2]?decodeURIComponent(o[2].replace(/\+/g," ")):""},r.setIcon=function(e){let t=document.querySelector("link[rel*='icon']")||document.createElement("link");t.type="image/x-icon",t.rel="shortcut icon",t.href=e,document.getElementsByTagName("head")[0].appendChild(t)},r.copyToTheClipBoard=function(e){let t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("Copy"),document.body.removeChild(t)},r.search=function(e,t){const o=function(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"")};let n=o(e.toLowerCase());return t.split(" ").map(e=>n.includes(o(e.toLowerCase()))).reduce((e,t)=>e&&t,!0)},r.wait=async function(e){return new Promise((t,o)=>{setTimeout(t,e,e)})},r.isFirefox=(()=>null!=browser.runtime.getBrowserInfo),r.isChrome=(()=>!r.isFirefox()),r.hasDiscardFunction=(()=>null!=browser.tabs.discard),r.hasSessionWindowValue=(()=>null!=browser.sessions.getWindowValue),r.hasWindowTitlePreface=(()=>r.isFirefox()),r.hasHideFunction=(()=>null!=browser.tabs.hide),r.isChrome=function(){return null==browser.sessions.getWindowValue&&null!=browser.tabs.discard},r.isFF57=function(){return void 0!==browser.sessions.getWindowValue},r.extractTabUrl=function(e=""){let t=e;return t.includes(r.LAZY_PAGE_URL)&&(t=r.getParameterByName("url",t)),t.includes(r.PRIV_PAGE_URL)&&(t=r.getParameterByName("url",t)),""===t?n.a.NEW_TAB:t},r.extractLazyUrl=function(e=""){let t=e;return t.includes(r.LAZY_PAGE_URL)&&(t=r.getParameterByName("url",t)),t},r.getPrivilegedURL=function(e,t,o){return browser.extension.getURL(r.PRIV_PAGE_URL)+"?title="+encodeURIComponent(e||"")+"&url="+encodeURIComponent(t)+"&favIconUrl="+encodeURIComponent(o||"")},r.getDiscardedURL=function(e,t,o){return t===n.a.NEW_TAB||"about:blank"===t||t.includes("chrome://newtab")?t:browser.extension.getURL(r.LAZY_PAGE_URL)+"?title="+encodeURIComponent(e||"")+"&url="+encodeURIComponent(t)+"&favIconUrl="+encodeURIComponent(o||"")},r.isPrivilegedURL=function(e){return e!==n.a.NEW_TAB&&"about:blank"!==e&&!e.includes("chrome://newtab")&&(!e.startsWith("data:image")&&!!(e.startsWith("chrome:")||e.startsWith("javascript:")||e.startsWith("data:")||e.startsWith("file:")||e.startsWith("about:")))},r.sendMessage=function(e,t){browser.runtime.sendMessage({task:e,params:t}).then((e,t)=>{}).catch(e=>{})},r.shuffleArray=function(e){for(let t=e.length-1;t>0;t--){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e},r.openUrlOncePerWindow=async function(e,t=!0){const o=(await browser.windows.getLastFocused()).id;let n=e,r=n.lastIndexOf("#")>-1;r&&(n=n.substring(0,n.lastIndexOf("#")));const a=await browser.tabs.query({windowId:o,url:n});if(a.length){let o={active:t};r&&(o.url=e),browser.tabs.update(a[0].id,o)}else browser.tabs.create({active:t,url:e})},r.extractSearchValue=function(e){let t="",o="";if(e.startsWith("g/")){let n=e.lastIndexOf("/");t=e.substring(2,n>1?n:e.length),o=e.substring(n>1?n+1:e.length,e.length)}else o=e;return[t,o]},r.getGroupTitle=function(e){return e.title||browser.i18n.getMessage("unnamed_group")+" "+e.id},r.objectHasUndefined=function(e,t="default"){if(void 0===e)return[!0,t];for(let o in e){if(void 0===e[o])return[!0,`${t}["${o}"]`];if("object"==typeof e[o]){const n=r.objectHasUndefined(e[o],`${t}["${o}"]`);if(n[0])return n}}return[!1,t]},r.ojectPropertiesAreUndefined=function(e,t,o="default"){if(null==e)return[!0,[o]];let n=!1;const r=[];for(let a in t)null==e[a]&&(null==t[a]?n=!0:e[a]=t[a],r.push(`${o}["${a}"]`));return[n,r]},r.isDeadObject=function(e){try{return String(e),!1}catch(e){return!0}},r.checkCorruptedObject=function(e,t="default"){const o={is:!1,msg:""};try{const n=r.isDeadObject(e);if(n)return o.is=n,o.msg="Dead Object",o;const[a,i]=r.objectHasUndefined(e,t);if(a)return o.is=a,o.msg="Undefined: "+i,o}catch(e){o.is=!0,o.msg="Catch on error."}return o},r.range=function(e){return[...Array(e).keys()]},r.createGroupsJsonFile=function(e,{prettify:t=!1}={}){return URL.createObjectURL(new Blob([JSON.stringify({version:["syncTabGroups",1],groups:e},null,t?2:0)],{type:"application/json"}))},r.waitDownload=async function(e,t=6){for(let o=0;o<4*t;o++){const t=await browser.downloads.search({id:e});if(t&&t.length>0&&"in_progress"!==t[0].state)break;await r.wait(250)}},r.windowExists=async function(e){return!(e===browser.windows.WINDOW_ID_NONE||e<0)&&(await browser.windows.getAll()).length>0},r.timerDecorator=function(e,{name:t="Perf",times:o=1}={}){return async function(){performance.now();for(let t=0;t<o;t++)await e.apply(this,arguments);performance.now()}},r.getParentElement=function(e,t){do{if(e.classList.contains(t))return e;e=e.parentElement}while(void 0!==e);throw Error("[Utils.getParentElement] Element nof found: "+t)},r.getOffset=function(e,t=document.body){let o=0,n=e;do{o+=n.offsetTop,n=n.offsetParent}while(n!==document.body&&!isNaN(n.offsetTop));let r=e;for(;r&&!isNaN(r.offsetTop);)o-=r.scrollTop,r=r.parentElement;return o},r.doActivateHotkeys=function(e,t){return t?e:()=>!1},t.a=r},21:function(e,t,o){"use strict";const n=function(){this.events=[]};n.prototype.on=function(e,t){this.events[e]=this.events[e]||[],this.events[e].push(t)},n.prototype.fire=function(e){this.events[e]&&this.events[e].forEach(function(e){e()})},t.a=n},23:function(e,t,o){"use strict";t.a=function(e){let t=[];for(let o=0;o<e.length;o++)for(let n=0;n<e.length;n++)e[n].position===o&&t.push(e[n].index);if(t.length<e.length)for(let o=0;o<e.length;o++)-1===t.indexOf(o)&&t.push(o);return t}},4:function(e,t,o){"use strict";var n=o(2),r=o(10),a=o(5);const i={};window.LogManager=i,i.LOG_NUMBER_LIMIT=1e4,i.NOTIFICATION_ID="LOG_ERROR",i.BACK="LOG_BACK",i.BACK="LOG_FRONT",i.LOCATION=i.BACK,i.EXTENSION_INSTALLED="EXTENSION_INSTALLED",i.EXTENSION_UPDATED="EXTENSION_UPDATED",i.EXTENSION_START="EXTENSION_START",i.EXTENSION_INITIALIZED="EXTENSION_INITIALIZED",i.EXTENSION_UPDATED="EXTENSION_UPDATED",i.SWITCH_GROUP_WITH_LOST="SWITCH_GROUP_WITH_LOST",i.logs=[];const s=browser.extension.getURL("/");i.isEnable=function(){return!a.a.options||a.a.options.log.enable},i.information=function(e,t=null,{print:o=n.a.DEBUG_MODE,logs:r=i.logs,enable:a=i.isEnable()}={}){if(!a)return;const s={type:"Information",time:Date(),message:e,data:n.a.getCopy(t)};return r&&i.addLog(s,{logs:r,print:o,enable:a}),s},i.warning=function(e,t=null,{print:o=n.a.DEBUG_MODE,logs:r=i.logs,enable:a=i.isEnable()}={}){if(!a)return;const s={type:"Warning",time:Date(),message:e,trace:i.getStack(Error().stack),data:n.a.getCopy(t)};return r&&i.addLog(s,{logs:r,print:o,enable:a}),s},i.error=function(e,t=null,{print:o=n.a.DEBUG_MODE,logs:r=i.logs,showNotification:a=!n.a.DEBUG_MODE,enable:c=i.isEnable()}={}){if(!c)return;let u=e;u instanceof Error||(u=Error(e.message?e.message:e));const d={type:"Error",time:Date(),message:u.message,trace:i.getStack(u.stack),data:n.a.getCopy(t)};return n.a.isChrome()||Object.assign(d,{fileName:u.fileName.replace(s,"/"),lineNumber:u.lineNumber,columnNumber:u.lineNumber}),r&&i.addLog(d,{logs:r,print:o,enable:c}),a&&i.showErrorNotification(),d},i.getStack=function(e){return n.a.isChrome()?e.split("at ").map(e=>e.replace(s,"/")).map(e=>e.replace("\n","")):e.split("@").map(e=>e.replace(s,"/")).map(e=>e.replace("\n"," => "))},i.addLog=function(e,{logs:t=i.logs,print:o=n.a.DEBUG_MODE,enable:r=i.isEnable()}={}){if(r)if(i.LOCATION===i.BACK){if(t.length>0&&t[t.length-1].message===e.message)return;t.push(e),t.length>i.LOG_NUMBER_LIMIT&&t.shift()}else i.sendLog(e)},i.sendLog=function(e){n.a.sendMessage("LogManager:Add",{log:e})},i.addWindowOnErrorListener=function({enable:e=i.isEnable()}={}){window.onerror=function(...t){const[,,,,o]=t;i.error(o,"Caught by window.onerror",{enable:e})}},i.downloadLog=async function(e=i.logs){try{let t=new Date;const o=n.a.isChrome()?"Chrome":await browser.runtime.getBrowserInfo();let r=URL.createObjectURL(new Blob([JSON.stringify({version:{SyncTabGroups:browser.runtime.getManifest().version,browser:o,os:(await browser.runtime.getPlatformInfo()).os},logs:e,options:a.a.options},null,2)],{type:"application/json"})),s="SyncTabGroups-Log-"+t.getFullYear()+("0"+(t.getMonth()+1)).slice(-2)+("0"+t.getDate()).slice(-2)+"-"+("0"+t.getHours()).slice(-2)+("0"+t.getMinutes()).slice(-2)+("0"+t.getSeconds()).slice(-2)+".json",c=await browser.downloads.download({url:r,filename:s,saveAs:!0});return await n.a.waitDownload(c),URL.revokeObjectURL(r),!0}catch(e){return i.error(e),!1}},i.showErrorNotification=function(){browser.notifications.create(i.NOTIFICATION_ID,{type:"basic",iconUrl:browser.extension.getURL("/share/icons/tabspace-active-64.png"),title:"Error caught in Sync Tab Groups",message:"An unexpected behavior happened in Sync Tab Groups. In order to improve the extension, could you send me the error back. Click on this notification to open the explanation on how to do it."})},i.init=function(){i.addWindowOnErrorListener(),browser.notifications.onClicked.addListener(e=>{e===i.NOTIFICATION_ID&&(r.a.onOpenSettings(!0),n.a.openUrlOncePerWindow("https://github.com/Morikko/sync-tab-groups/wiki/How-to-help-me-solve-bugs"))}),browser.runtime.onMessage.addListener(function(e){switch(e.task){case"LogManager:Add":i.addLog(e.params.log);break;case"LogManager:Download":i.downloadLog(i.logs)}})},t.a=i},5:function(e,t,o){"use strict";var n=o(2),r=o(4),a=o(1),i=o(14),s=o(21),c=o(8),u=o(6),d=o(15),p=o(7);const l={};window.OptionManager=l,l.EVENT_CHANGE="options-change",l.eventlistener=new s.a,l.checkerInterval=void 0,l.repeatedtask=new i.a.RepeatedTask(5e3),l.updateOption=async function(e,t){switch(e){case"backup-local-intervalTime":t=parseFloat(t,10),t=Math.max(.01,t);break;case"backup-local-maxSave":t=parseInt(t,10),t=Math.max(1,t)}if(void 0!==t&&!isNaN(t)){switch(e.split("-").reduce((e,o,n,r)=>(n===r.length-1&&(e[o]=t),e[o]),l.options),e){case"privateWindow-sync":break;case"pinnedTab-sync":l.onPinnedTabSyncChange(t);break;case"groups-removeEmptyGroup":l.onRemoveEmptyGroupChange();break;case"popup-whiteTheme":l.onPopupThemeChange(t);break;case"groups-showGroupTitleInWindow":l.onShowGroupTitleInWindowChange(t);break;case"groups-sortingType":a.a.eventlistener.fire(a.a.EVENT_PREPARE);break;case"backup-download-enable":l.onDownloadBackUpEnableChange(t);break;case"backup-local-enable":await l.onLocalBackUpEnableChange(t);break;case"backup-local-intervalTime":await p.a.Local.planBackUp();break;case"backup-local-maxSave":await p.a.Local.respectMaxBackUp();break;case"groups-closingState":await l.onClosingStateChange(t);break;case"groups-removeUnknownHiddenTabs":await l.onRemoveUnknownHiddenTabsChange(t)}e.startsWith("backup-time-")&&l.onBackUpTimerChange(e.substring("backup-download-time-".length),t),l.eventlistener.fire(l.EVENT_CHANGE)}},l.getOptionValue=function(e){return e.split("-").reduce((e,t,o,n)=>e[t],l.options)},l.onClosingStateChange=async function(e){e===u.a.CLOSE_NORMAL?await d.a.closeAllHiddenTabsInGroups(a.a.groups):e===u.a.CLOSE_HIDDEN&&await l.updateOption("pinnedTab-sync",!1)},l.onRemoveUnknownHiddenTabsChange=async function(e){e?await d.a.startCleaningUnknownHiddenTabsProcess({doItNow:!0}):d.a.stopCleaningUnknownHiddenTabsProcess()},l.onDownloadBackUpEnableChange=function(e){e?p.a.Backup.init():p.a.Backup.stopAll()},l.onLocalBackUpEnableChange=async function(e){e?await p.a.Local.planBackUp():p.a.Local.abortBackUp()},l.onBackUpTimerChange=function(e,t){t?p.a.Backup.startTimer(e):p.a.Backup.stopTimer(e)},l.onShowGroupTitleInWindowChange=function(e){if(n.a.hasWindowTitlePreface())for(let t of a.a.groups)t.windowId!==browser.windows.WINDOW_ID_NONE&&(e?c.a.setWindowPrefixGroupTitle(t.windowId,t):browser.windows.update(t.windowId,{titlePreface:" "}))},l.onPopupThemeChange=function(e){n.a.setBrowserActionIcon(e)},l.onPrivateWindowSyncChange=async function(e){try{return e?await a.a.integrateAllOpenedWindows():await a.a.removeGroupsInPrivateWindow(),"OptionManager.onPrivateWindowSyncChange done!"}catch(e){r.a.error(e)}},l.onPinnedTabSyncChange=async function(e){e&&l.options.groups.closingState===u.a.CLOSE_HIDDEN&&await l.updateOption("groups-closingState",u.a.CLOSE_NORMAL);try{return await a.a.updateAllOpenedGroups(),"OptionManager.onPinnedTabSyncChange done!"}catch(e){r.a.error(e)}},l.onRemoveEmptyGroupChange=function(){l.options.groups.removeEmptyGroup&&a.a.removeEmptyGroup()},l.init=async function(){try{let e=await p.a.Local.loadOptions();return l.options=l.check_integrity(e),l.initEventListener(),l.eventlistener.fire(l.EVENT_CHANGE),"OptionManager.init done"}catch(e){r.a.error(e)}},l.check_integrity=function(e){let t=u.a.TEMPLATE();return n.a.mergeObject(e,t),e},l.store=function(){if(!l.checkCorruptedOptions(l.options))return p.a.Local.saveOptions(l.options)},l.initEventListener=function(){l.eventlistener.on(l.EVENT_CHANGE,()=>{l.repeatedtask.add(()=>{l.store()})}),l.checkerInterval=setInterval(()=>{l.checkCorruptedOptions(l.options)},3e4)},l.reloadOptionsFromDisk=async function(){l.options=await p.a.Local.loadGroups()},l.checkCorruptedOptions=function(e=l.options){const{is:t,msg:o}=n.a.checkCorruptedObject(e,"options");return t&&(r.a.warning("OptionManager.checkCorruptedOptions has detected a corrupted options: "+o),n.a.DEBUG_MODE||l.reloadOptionsFromDisk()),t},l.isClosingAlived=function(){return!1},l.isClosingHidden=function(){return l.options.groups.closingState===u.a.CLOSE_HIDDEN},t.a=l},6:function(e,t,o){"use strict";var n=o(2);const r={SORT_OLD_RECENT:0,SORT_RECENT_OLD:1,SORT_ALPHABETICAL:2,SORT_LAST_ACCESSED:3,SORT_CUSTOM:4,CLOSE_NORMAL:0,CLOSE_ALIVE:1,CLOSE_HIDDEN:2,TIMERS:function(){return{t_5mins:3e5,t_1h:36e5,t_4h:144e5,t_1d:864e5,t_1w:6048e5}},TEMPLATE:function(){return{version:.1,privateWindow:{sync:!1,removeOnClose:!0},pinnedTab:{sync:!1},bookmarks:{sync:!1,folder:"Default"},groups:{syncNewWindow:!0,removeEmptyGroup:!1,showGroupTitleInWindow:!1,sortingType:r.SORT_LAST_ACCESSED,discardedOpen:!0,closingState:r.CLOSE_NORMAL,discardedHide:!1,removeUnknownHiddenTabs:!1},popup:{maximized:!1,whiteTheme:!1,showTabsNumber:!0,showSearchBar:!0},shortcuts:{allowGlobal:!1,navigation:!0},backup:{download:{enable:!1,time:n.a.setObjectPropertiesWith(r.TIMERS(),!0)},local:{enable:!0,intervalTime:1,maxSave:48}},log:{enable:!0}}}};t.a=r},62:function(e,t,o){"use strict";t.a=async function(e){return new Promise((t,o)=>{let n=new FileReader;n.addEventListener("loadend",function(e){try{t(JSON.parse(e.target.result))}catch(e){o("Impossible to read file: "+e)}}),n.addEventListener("error",function(e){o("Error when reading file: "+e)}),n.readAsText(e,"utf-8")})}},68:function(e,t,o){"use strict";o.r(t);var n=o(4),r=o(2),a=o(7),i=o(5),s=o(1),c=o(8);const u={initCommandsEventListener:function(){browser.commands.onCommand.addListener(async function(e){try{if(!i.a.options.shortcuts.allowGlobal)return"";switch(e){case"swtich_next_group":c.a.selectNextGroup();break;case"swtich_previous_group":c.a.selectNextGroup({direction:-1});break;case"create_group_swtich":c.a.selectGroup(s.a.addGroup());break;case"focus_next_group":c.a.selectNextGroup({open:!0});break;case"focus_previous_group":c.a.selectNextGroup({direction:-1,open:!0});break;case"remove_group_swtich":await c.a.removeGroup()}}catch(e){n.a.error(e,{args:arguments})}})}};var d=u,p=o(10);const l={DEV_TABS:["/tests/test-page/unit.html","/tests/test-page/integration.html","/options/option-page.html#settings"],onDevelopmentInstall:function(){l.DEV_TABS.forEach(e=>{browser.tabs.create({active:!1,url:browser.extension.getURL(e)})})},onNewInstall:function(){p.a.install=!0,p.a.onOpenSettings(!1)},onUpdate:function(e){p.a.lastVersion=e,browser.notifications.onClicked.addListener(e=>{e===p.a.updateNotificationId&&p.a.onOpenSettings(!0)}),browser.notifications.create(p.a.updateNotificationId,{type:"basic",iconUrl:browser.extension.getURL("/share/icons/tabspace-active-64.png"),title:browser.i18n.getMessage("notification_update_title")+" "+browser.runtime.getManifest().version,message:browser.i18n.getMessage("notification_update_message")})},isVersionBelow:function(e,t){let o=e.split(".").map(e=>parseInt(e,10)),n=t.split(".").map(e=>parseInt(e,10));return o[0]<n[0]||!(o[0]>n[0])&&(o[1]<n[1]||!(o[1]>n[1])&&(o[2]<n[2]||!(o[2]>n[2])))},prepareExtensionForUpdate:function(e,t){e&&l.isVersionBelow(e,"0.6.2")&&!l.isVersionBelow(t,"0.6.2")&&l.updateFromBelow_0_6_2()},updateFromBelow_0_6_2:function(e=i.a.options){e.hasOwnProperty("backup")&&(e.backup.hasOwnProperty("download")||(e.backup.download={}),e.backup.hasOwnProperty("enable")&&(e.backup.download.enable=e.backup.enable,delete e.backup.enable),e.backup.hasOwnProperty("time")&&(e.backup.download.time=e.backup.time,delete e.backup.time))}};var w=l;const g={initSendDataEventListener:function(){s.a.eventlistener.on(s.a.EVENT_CHANGE,()=>{p.a.refreshUi()}),i.a.eventlistener.on(i.a.EVENT_CHANGE,()=>{p.a.refreshOptionsUI()}),a.a.Local.eventlistener.on(a.a.Local.BACKUP_CHANGE,()=>{p.a.refreshBackupListUI()})}};var f=g,b=o(9),I=o(15);const h={initTabsEventListener:function(){browser.tabs.onActivated.addListener(async e=>{setTimeout(async function(){b.a.updateTabsInGroup(e.windowId)},300)}),browser.tabs.onCreated.addListener(async e=>{await b.a.updateTabsInGroup(e.windowId)}),browser.tabs.onRemoved.addListener(async(e,t)=>{setTimeout(async function(){t.isWindowClosing||await b.a.updateTabsInGroup(t.windowId)},300),r.a.hasHideFunction()&&i.a.isClosingHidden()&&I.a.changeHiddenStateForTab(e)}),browser.tabs.onMoved.addListener(async(e,t)=>{await b.a.updateTabsInGroup(t.windowId)}),browser.tabs.onUpdated.addListener(async(e,t,o)=>{await b.a.updateTabsInGroup(o.windowId)}),browser.tabs.onAttached.addListener(async(e,t)=>{await b.a.updateTabsInGroup(t.newWindowId)}),browser.tabs.onDetached.addListener(async(e,t)=>{await b.a.updateTabsInGroup(t.oldWindowId)})}};var m=h,T=o(19),E=o(14),G=o(62),y=o(23);const v={};v.MoveTabMenu_ID="stg-move-tab-group-",v.SpecialActionMenu_ID="stg-special-actions-",v.MoveTabMenuIds=[],v.SpecialActionMenuIds=[],v.repeatedtask=new E.a.RepeatedTask(1e3),v.occupied=!1,v.again=!1,v.createMoveTabMenu=async function(){try{if(v.occupied)return void(v.again=!0);v.occupied=!0;for(let e of v.MoveTabMenuIds)try{await browser.contextMenus.remove(e)}catch(e){return}await r.a.wait(100),v.MoveTabMenuIds.length=0;const e=["page"];r.a.isChrome()||e.push("tab");let t=v.MoveTabMenu_ID+"title";v.MoveTabMenuIds.push(t);const o={id:t,title:browser.i18n.getMessage("move_tab_group"),contexts:e};let a;r.a.isChrome()||(o.icons={64:"/share/icons/tabspace-active-64.png",32:"/share/icons/tabspace-active-32.png"}),await browser.contextMenus.create(o);try{a=(await browser.windows.getLastFocused()).id}catch(e){n.a.warning(e.message)}let i=s.a.getCopy(),c=Object(y.a)(i);for(let o of c){v.MoveTabMenuIds.push(v.MoveTabMenu_ID+i[o].id);const n=i[o].windowId!==browser.windows.WINDOW_ID_NONE?"[OPEN]":"";await browser.contextMenus.create({id:v.MoveTabMenu_ID+i[o].id,title:n+" "+r.a.getGroupTitle(i[o]),contexts:e,parentId:t,enabled:a!==i[o].windowId})}v.MoveTabMenuIds.push(v.MoveTabMenu_ID+"separator-2"),await browser.contextMenus.create({id:v.MoveTabMenu_ID+"separator-2",type:"separator",contexts:e,parentId:t}),v.MoveTabMenuIds.push(v.MoveTabMenu_ID+"new"),await browser.contextMenus.create({id:v.MoveTabMenu_ID+"new",title:browser.i18n.getMessage("add_group"),contexts:e,parentId:t}),v.again&&(setTimeout(()=>{v.repeatedtask.add(()=>v.createMoveTabMenu())},0),v.again=!1)}catch(e){n.a.error(e)}finally{v.occupied=!1}},v.updateMoveFocus=async function(e){try{if(v.occupied)return;return v.occupied=!0,await Promise.all(v.MoveTabMenuIds.map(t=>{let o=t.substring(v.MoveTabMenu_ID.length),n=parseInt(o);if(n>=0){let o=s.a.getGroupIndexFromGroupId(n,{error:!1});if(o>=0)return browser.contextMenus.update(t,{enabled:e!==s.a.groups[o].windowId})}return Promise.resolve()})),void(v.occupied=!1)}catch(e){n.a.error(e,null,{showNotification:!1})}finally{v.occupied=!1}},v.createSpecialActionMenu=function(){let e={id:v.SpecialActionMenu_ID+"manage_groups",title:browser.i18n.getMessage("group_manager"),contexts:["browser_action"]};r.a.isFirefox()&&(e.icons={64:"/share/icons/list-64.png",32:"/share/icons/list-32.png"}),browser.contextMenus.create(e);let t={id:v.SpecialActionMenu_ID+"export_groups",title:browser.i18n.getMessage("export_groups"),contexts:["browser_action"]};r.a.isFirefox()&&(t.icons={64:"/share/icons/upload-64.png",32:"/share/icons/upload-32.png"}),browser.contextMenus.create(t);let o={id:v.SpecialActionMenu_ID+"backup",title:browser.i18n.getMessage("contextmenu_backup"),contexts:["browser_action"]};r.a.isFirefox()&&(o.icons={64:"/share/icons/hdd-o-64.png",32:"/share/icons/hdd-o-32.png"}),browser.contextMenus.create(o);let n={id:v.SpecialActionMenu_ID+"open_preferences",title:browser.i18n.getMessage("contextmenu_preferences"),contexts:["browser_action"]};if(r.a.isFirefox()&&(n.icons={64:"/share/icons/gear-64.png",32:"/share/icons/gear-32.png"}),browser.contextMenus.create(n),r.a.DEBUG_MODE){let e={id:v.SpecialActionMenu_ID+"open_tests",title:"Tests",contexts:["browser_action"]};browser.contextMenus.create(e)}},v.MoveTabMenuListener=function(e,t){if(e.menuItemId.includes(v.MoveTabMenu_ID)){let o=e.menuItemId.substring(v.MoveTabMenu_ID.length,e.menuItemId.length),n=parseInt(o);n>=0?b.a.moveUnFollowedTabToGroup(t.id,n):"new"===o&&b.a.moveUnFollowedTabToNewGroup(t.id)}},v.SpecialActionMenuListener=function(e,t){if(e.menuItemId.includes(v.SpecialActionMenu_ID)){switch(e.menuItemId.substring(v.SpecialActionMenu_ID.length,e.menuItemId.length)){case"export_groups":p.a.onExportGroups();break;case"import_groups":!function(){const e=document.createElement("input");e.type="file",e.accept=".json",e.acceptCharset="utf-8",e.onchange=(()=>{Object(G.a)(e.files[0]).then(e=>{p.a.onImportGroups({content_file:e})})}),e.click()}();break;case"save_bookmarks_groups":p.a.onBookmarkSave();break;case"open_preferences":p.a.onOpenSettings();break;case"manage_groups":r.a.openUrlOncePerWindow(browser.extension.getURL("/manage/manage-groups.html"));break;case"backup":a.a.Backup.backup("manual");break;case"guide":p.a.onOpenGuide();break;case"open_tests":r.a.openUrlOncePerWindow(browser.extension.getURL("/tests/test-page/test-page.html"),!0)}}},v.initContextMenus=function(){browser.contextMenus.onClicked.addListener(v.SpecialActionMenuListener),browser.contextMenus.onClicked.addListener(v.MoveTabMenuListener),v.createMoveTabMenu(),v.createSpecialActionMenu(),s.a.eventlistener.on(s.a.EVENT_CHANGE,()=>{v.repeatedtask.add(()=>{v.createMoveTabMenu()})})};var O=v;const _={initWindowsEventListener:function(){browser.windows.onCreated.addListener(e=>{r.a.DEBUG_MODE,!i.a.options.privateWindow.sync&&e.incognito||setTimeout(async function(){if(!c.a.WINDOW_EXCLUDED.opening)try{await c.a.integrateWindow(e.id)}catch(t){n.a.error(t,{window:e})}},300)}),browser.windows.onRemoved.addListener(function(e){r.a.DEBUG_MODE,c.a.WINDOW_CURRENTLY_CLOSING[e]=!0,T.a.wasClosedGroupsSelector(e),setTimeout(()=>{delete c.a.WINDOW_CURRENTLY_CLOSING[e]},5e3),s.a.detachWindow(e)}),browser.windows.onFocusChanged.addListener(async function(e){p.a.refreshUi();try{if(e>=0){const t=await browser.windows.getLastFocused();await O.updateMoveFocus(t.id);let o=s.a.getGroupIdInWindow(e,{error:!1});o>=0&&s.a.setLastAccessed(o,Date.now())}}catch(e){n.a.error(e,{args:arguments})}})}};const N={Commands:d,Install:w,Extension:f,Tabs:m,Windows:_};window.Events=N;var W=N;const k={popupMessenger:function(e){switch(e.task){case"Group:Add":p.a.onGroupAdd(e.params);break;case"Group:AddWithTab":p.a.onGroupAddWithTab(e.params);break;case"Group:Close":p.a.onGroupClose(e.params);break;case"Group:ChangePosition":p.a.onGroupChangePosition(e.params);break;case"Group:Remove":p.a.onGroupRemove(e.params);break;case"Group:Rename":p.a.onGroupRename(e.params);break;case"Group:Select":p.a.onGroupSelect(e.params);break;case"Group:MoveTab":p.a.onMoveTabToGroup(e.params);break;case"Tab:Select":p.a.onTabSelect(e.params);break;case"Group:OpenGroupInNewWindow":p.a.onOpenGroupInNewWindow(e.params);break;case"Data:Ask":p.a.refreshData(e.params);break;case"App:OpenSettings":p.a.onOpenSettings();break;case"Window:Sync":p.a.changeSynchronizationStateOfWindow(e.params);break;case"Tab:Open":p.a.onTabOpen(e.params);break;case"Tab:Close":p.a.onTabClose(e.params);break;case"Tab:ChangePin":p.a.onTabChangePin(e.params);break;case"Group:Expand":p.a.onChangeExpand(e.params);break;case"Tab:RemoveHiddenTab":p.a.onRemoveHiddenTab(e.params);break;case"Group:RemoveHiddenTabsInGroup":p.a.onRemoveHiddenTabsInGroup(e.params)}}};var C=k;const D={optionMessenger:function(e){switch(e.task){case"Option:Ask":p.a.refreshOptionsUI();break;case"BackupList:Ask":p.a.refreshBackupListUI();break;case"Option:Change":i.a.updateOption(e.params.optionName,e.params.optionValue),p.a.refreshOptionsUI();break;case"Option:BackUp":p.a.onBookmarkSave();break;case"Option:Import":p.a.onImportGroups(e.params),p.a.refreshUi();break;case"Option:Export":p.a.onExportGroups();break;case"Option:DeleteAllGroups":p.a.onRemoveAllGroups();break;case"Option:ReloadGroups":p.a.onReloadGroups();break;case"Option:OpenGuide":p.a.onOpenGuide();break;case"Option:UndiscardLazyTabs":b.a.undiscardAll();break;case"Option:RemoveBackUp":p.a.onRemoveBackUp(e.params.id);break;case"Option:ImportBackUp":p.a.onImportBackUp(e.params.id);break;case"Option:ExportBackUp":p.a.onExportBackUp(e.params.id)}}};var U=D,A=o(18);const L={selectorMessenger:function(e){switch(e.task){case"Ask:SelectorGroups":r.a.sendMessage("Selector:Groups",{groups:T.a.groups});break;case"Selector:Finish":L.manageFinish(e.params);break;case"Ask:Options":p.a.refreshOptionsUI()}},manageFinish:async function({filter:e,importType:t}){let o=!1;if(T.a.type===A.a.EXPORT)o=await a.a.File.downloadGroups(s.a.filterGroups(T.a.groups,e));else{o=s.a.addGroups(s.a.filterGroups(T.a.groups,e),{showNotification:!0}).length>0}o&&await T.a.closeGroupsSelector()}};var R={Groups:C,Options:U,Selector:L};n.a.LOCATION=n.a.BACK,browser.runtime.onInstalled.addListener(e=>{"install"===e.reason?(W.Install.onNewInstall(),n.a.information(n.a.EXTENSION_INSTALLED)):r.a.isFirefox()&&e.temporary||r.a.isChrome()&&"update"===e.reason&&browser.runtime.getManifest().version===e.previousVersion?W.Install.onDevelopmentInstall():"update"===e.reason&&browser.runtime.getManifest().version!==e.previousVersion&&(W.Install.onUpdate(e.previousVersion),n.a.information(n.a.EXTENSION_UPDATED))}),r.a.isChrome()&&browser.runtime.onUpdateAvailable.addListener(b.a.undiscardAll),async function(){n.a.init(),n.a.information(n.a.EXTENSION_START),await i.a.init(),await s.a.init(),W.Install.prepareExtensionForUpdate(p.a.lastVersion,browser.runtime.getManifest().version),W.Extension.initSendDataEventListener(),W.Tabs.initTabsEventListener(),W.Windows.initWindowsEventListener(),W.Commands.initCommandsEventListener(),O.initContextMenus(),browser.runtime.onMessage.addListener(R.Groups.popupMessenger),browser.runtime.onMessage.addListener(R.Options.optionMessenger),browser.runtime.onMessage.addListener(R.Selector.selectorMessenger),browser.runtime.onMessage.addListener(e=>{r.a.UTILS_SHOW_MESSAGES}),r.a.setBrowserActionIcon(i.a.options.popup.whiteTheme),p.a.refreshUi(),p.a.refreshOptionsUI(),await r.a.wait(2e3),a.a.Local.planBackUp(),a.a.Backup.init(),p.a.install=!1,n.a.information(n.a.EXTENSION_INITIALIZED,{groups:s.a.groups.map(e=>({id:e.id,tabsLength:e.tabs.length,windowId:e.windowId}))})}()},7:function(e,t,o){"use strict";var n=o(14),r=o(2),a=o(4),i=o(5);const s={ROOT:"SyncTabGroups",ROOT_ID:null};s.repeatedtask=new n.a.RepeatedTask(3e4),s.backUp=function(e,t=!1){s.repeatedtask.add(async()=>{try{return await s.init(),await s.cleanGroups(),await s.saveGroups(e),"Bookmark.backUp done!"}catch(e){a.a.error(e,{args:arguments})}},t)},s.saveGroups=async function(e){try{let t;t=(await browser.bookmarks.create({title:""===i.a.options.bookmarks.folder?"Default":i.a.options.bookmarks.folder,parentId:s.ROOT_ID})).id;for(let o of e){const e=await browser.bookmarks.create({title:r.a.getGroupTitle(o),parentId:t});for(let t of o.tabs)await browser.bookmarks.create({title:t.title,index:t.index,url:t.url,parentId:e.id})}return"Bookmark.saveGroups done!"}catch(e){a.a.error(e,{args:arguments})}},s.cleanGroups=async function(e=s.BACKUP_OLD){try{const e=await browser.bookmarks.getSubTree(s.ROOT_ID);for(let t of e[0].children)t.title===i.a.options.bookmarks.folder&&await browser.bookmarks.removeTree(t.id);return"Bookmark.cleanGroups done!"}catch(e){a.a.error(e,{args:arguments})}},s.init=async function(){try{const e=await browser.bookmarks.search({title:s.ROOT});if(0===e.length){const e=await browser.bookmarks.create({title:s.ROOT});s.ROOT_ID=e.id}else s.ROOT_ID=e[0].id;return"Bookmark.init done!"}catch(e){a.a.error(e,{args:arguments})}};var c=s,u=o(21),d=o(1),p=o(6);const l={BACKUP_TIMEOUT:null,BACKUP_CHANGE:"backup-change"};l.eventlistener=new u.a,l.BACKUP_TIMEOUT_PROMISE=Promise.resolve(),l.saveGroups=async function(e){let t=d.a.getGroupsWithoutPrivate(e);try{await browser.storage.local.set({groups:t}),0===t.length&&a.a.information("LocalStorage.saveGroups saved empty group.")}catch(e){a.a.error(e,{args:arguments})}},l.loadGroups=async function(){try{const{groups:e}=await browser.storage.local.get({groups:[]});return 0===e.length&&a.a.information("LocalStorage.loadGroups loaded empty group."),e}catch(e){return"LocalStorage.loadGroups failed... "+e}},l.cleanGroups=function(){return browser.storage.local.remove("groups")},l.saveOptions=function(e){return browser.storage.local.set({options:e})},l.loadOptions=async function(){try{return(await browser.storage.local.get({options:p.a.TEMPLATE()})).options}catch(e){return"LocalStorage.loadOptions failed... "+e}},l.cleanOptions=async function(){return browser.storage.local.remove("options")},l.abortBackUp=function(){l.BACKUP_TIMEOUT&&(clearTimeout(l.BACKUP_TIMEOUT),l.BACKUP_TIMEOUT=void 0,l.BACKUP_TIMEOUT_PROMISE=Promise.resolve())},l.planBackUp=async function(e=d.a.groups,t=Math.floor(3600*i.a.options.backup.local.intervalTime*1e3)){if(!i.a.options.backup.local.enable)return;let o;l.abortBackUp();const n=await l.getBackUpList();let r=Object.values(n).map(e=>e.date).sort().reverse()[0],a=r?Date.now()-r:t;return a>=t&&(o=await l.addBackup({groups:e}),a=0),l.BACKUP_TIMEOUT_PROMISE=new Promise((o,n)=>{l.BACKUP_TIMEOUT=setTimeout(async function(){await l.addBackup({groups:e}),await l.planBackUp(e),o()},t-a)}),o},l.getBackUpList=async function(){return(await browser.storage.local.get({backupList:{}})).backupList},l.setBackUpList=async function(e={},{fireEvent:t=!0}={}){await browser.storage.local.set({backupList:e}),t&&l.eventlistener.fire(l.BACKUP_CHANGE)},l.getBackUp=async function(e){return(await browser.storage.local.get(e))[e]},l.addBackup=async function({groups:e=d.a.groups,time:t=(new Date).getTime(),fireEvent:o=!0}={}){let n=await l.getBackUpList();const r="backup-"+t;n[r]={date:t},await l.setBackUpList(n,{fireEvent:!1});let a=d.a.getGroupsWithoutPrivate(e);return await browser.storage.local.set({[r]:a}),await l.respectMaxBackUp({fireEvent:!1}),o&&l.eventlistener.fire(l.BACKUP_CHANGE),r},l.respectMaxBackUp=async function({maxSave:e=i.a.options.backup.local.maxSave,fireEvent:t=!0}={}){const o=Object.entries(await l.getBackUpList()).sort((e,t)=>t[1].date-e[1].date).filter((t,o)=>o>=e);let n=Promise.resolve();await Promise.all(o.map(e=>n=n.then(t=>l.removeBackup(e[0],{fireEvent:!1})))),t&&l.eventlistener.fire(l.BACKUP_CHANGE)},l.removeBackup=async function(e,{fireEvent:t=!0}={}){Array.isArray(e)||(e=[e]);let o=await l.getBackUpList();for(let t of e)o.hasOwnProperty(t)&&delete o[t],await browser.storage.local.remove(t);await l.setBackUpList(o,{fireEvent:!1}),t&&l.eventlistener.fire(l.BACKUP_CHANGE)},l.clearBackups=async function({fireEvent:e=!0}={}){const t=await l.getBackUpList();for(let e in t)await browser.storage.local.remove(e);await l.setBackUpList({},{fireEvent:!1}),e&&l.eventlistener.fire(l.BACKUP_CHANGE)},l.getBackUpDate=function(e){if(e&&e.length){let t=e.split("-")[1];if(t&&t.length){let e=parseInt(t);if(!isNaN(e))return new Date(e).toString()}}return"Unknown date"};var w=l,g=o(9);const f={downloadGroups:async function(e){try{let t=d.a.getGroupsWithoutPrivate(e);t=t.map(e=>{return r.a.getCopy(e)});let o=new Date,n=r.a.createGroupsJsonFile(t,{prettify:!0}),i="syncTabGroups-manual-"+o.getFullYear()+("0"+(o.getMonth()+1)).slice(-2)+("0"+o.getDate()).slice(-2)+"-"+("0"+o.getHours()).slice(-2)+("0"+o.getMinutes()).slice(-2)+("0"+o.getSeconds()).slice(-2)+".json",s=await browser.downloads.download({url:n,filename:i,saveAs:!0});return await r.a.waitDownload(s),URL.revokeObjectURL(n),!0}catch(e){return a.a.error(e,{args:arguments}),!1}},importGroupsFromFile:function(e){try{if(!e.hasOwnProperty("version"))throw Error("ImportGroups: Content file is not in a supported format.");let t=[];if("tabGroups"===e.version[0]||"sessionrestore"===e.version[0])t=f.importTabGroups(e);else{if("syncTabGroups"!==e.version[0])throw Error("ImportGroups: Content file is not in a supported format.");t=f.importSyncTabGroups(e)}return d.a.prepareGroups(t,{fireEvent:!1}),t}catch(e){browser.notifications.create({type:"basic",iconUrl:browser.extension.getURL("/share/icons/tabspace-active-64.png"),title:"Impossible to read the file",message:e.message,eventTime:4e3}),a.a.error(e,{args:arguments})}},importSyncTabGroups:function(e){if(!e.hasOwnProperty("version")||!e.hasOwnProperty("groups")||"syncTabGroups"!==e.version[0])throw Error("SyncTabGroups importation: Content file is not readable.");return e.groups.map((e,t)=>new d.a.Group({id:t,title:e.title||"",tabs:e.tabs||[]}))},importTabGroups:function(e){if(!e.hasOwnProperty("version")||"tabGroups"!==e.version[0]&&"sessionrestore"!==e.version[0]||!e.hasOwnProperty("windows"))throw Error("TabGroups importation: Content file is not readable.");let t=[],o=[];for(let n of e.windows){let e={};if(!n.hasOwnProperty("extData")||!n.extData.hasOwnProperty("tabview-group"))throw Error("TabGroups importation: Content file is not readable..");let r=JSON.parse(n.extData["tabview-group"]);for(let o in r){let n=r[o];void 0!==n&&(t.push(new d.a.Group({id:t.length,title:n.title||"",tabs:[]})),e[n.id]=t.length-1)}if(!n.hasOwnProperty("tabs"))throw Error("TabGroups importation: Content file is not readable...");for(let r of n.tabs){if(!r.hasOwnProperty("extData")||!r.extData.hasOwnProperty("tabview-tab")||JSON.parse(r.extData["tabview-tab"])&&!JSON.parse(r.extData["tabview-tab"]).hasOwnProperty("groupID")||!JSON.parse(r.extData["tabview-tab"])&&!r.hasOwnProperty("pinned")||!r.hasOwnProperty("entries")||!r.entries[0].hasOwnProperty("title")||!r.entries[0].hasOwnProperty("url"))continue;let n={title:r.entries[0].title,url:r.entries[0].url,pinned:!1,active:!1};if(r.hasOwnProperty("image")&&(n.favIconUrl=r.image),r.hasOwnProperty("lastAccessed")&&(n.lastAccessed=r.lastAccessed),JSON.parse(r.extData["tabview-tab"])){t[e[JSON.parse(r.extData["tabview-tab"]).groupID]].tabs.push(g.a.getTabFactory(n))}else n.pinned=!0,o.push(n)}}return o.length>0&&t.push(new d.a.Group({id:t.length,title:"Imported Pinned Tabs",tabs:o})),t}};var b=f;const I={};I.TIMERS=r.a.setObjectPropertiesWith(p.a.TIMERS(),void 0),I.init=function(){if(i.a.options.backup.download.enable){I.TIMERS={};for(let e in i.a.options.backup.download.time)i.a.options.backup.download.time[e]?I.startTimer(e):I.TIMERS[e]=void 0}},I.stopAll=function(){for(let e in I.TIMERS)I.stopTimer(e)},I.stopTimer=function(e){I.TIMERS[e]&&clearInterval(I.TIMERS[e]),I.TIMERS[e]=void 0},I.startTimer=function(e){I.stopTimer(e),I.TIMERS[e]=setInterval(function(){I.backup(e.substring(2))},p.a.TIMERS()[e])},I.backup=async function(e,t=d.a.groups){try{if(d.a.checkCorruptedGroups(t))return;let o=r.a.createGroupsJsonFile(d.a.getGroupsWithoutPrivate(t)),n=await browser.downloads.download({url:o,filename:I.LOCATION+"synctabgroups-backup-"+e+".json",conflictAction:"overwrite",saveAs:!1});await r.a.waitDownload(n),await browser.downloads.erase({id:n}),URL.revokeObjectURL(o)}catch(e){a.a.error(e,{args:arguments})}};const h={Bookmark:c,Local:w,File:b,Backup:I};window.ExtensionStorageManager=h;t.a=h},8:function(e,t,o){"use strict";var n=o(2),r=o(4),a=o(1),i=o(9),s=o(5),c=o(23);const u={};function d(e,{groups:t=a.a.groups}={}){let o;function n(t){r.a.error(t,{snapGroup:e,actualGroup:o})}if(null==e)return n("Snap doesn't exist.");if(null==(o=a.a.getGroupFromGroupId(e.id,{groups:t,error:!1})))return n("Group has disappeared.");if(o.title!==e.title)return n("Title has changed.");const i=0===e.tabsLength&&1===o.tabs.length;return!(o.tabs.length!==e.tabsLength&&!i)||n("Tabs length has changed.")}function p(e){return{title:e.title,id:e.id,tabsLength:e.tabs.length}}window.WindowManager=u,u.WINDOW_GROUPID="groupId",u.WINDOW_CURRENTLY_SWITCHING={},u.GROUP_CURRENTLY_SWITCHING={},u.WINDOW_CURRENTLY_CLOSING={},u.WINDOW_EXCLUDED={},u.openGroupInWindow=async function(e,t,{forceClosing:o=!1}={}){try{let n=a.a.getGroupIndexFromGroupId(e);return await i.a.openListOfTabs(a.a.groups[n].tabs,t,{openAtLeastOne:!0,pendingTab:!0,forceClosing:o}),await a.a.attachWindowWithGroupId(e,t),"WindowManager.openGroupInWindow done!"}catch(e){r.a.error(e,{args:arguments})}},u.decoratorCurrentlyChanging=function(e){return async function(){let t,o,n;try{if(o=await browser.windows.getLastFocused(),u.WINDOW_CURRENTLY_SWITCHING.hasOwnProperty(o.id))return browser.notifications.create({type:"basic",iconUrl:browser.extension.getURL("/share/icons/tabspace-active-64.png"),title:"Can't change Group now",message:"Reason: the current window has not finished to switch to a group.",eventTime:4e3}),e.name+" not done because the current window has not finished to switch to a group.";u.WINDOW_CURRENTLY_SWITCHING[o.id]=!0,null!=(n=a.a.getGroupIdInWindow(o.id,{error:!1}))&&n>-1&&(u.GROUP_CURRENTLY_SWITCHING[n]=!0),t=await e.apply(this,arguments)}catch(e){r.a.error(e,{args:arguments})}finally{if(u.WINDOW_CURRENTLY_SWITCHING.hasOwnProperty(o.id)&&delete u.WINDOW_CURRENTLY_SWITCHING[o.id],null!=n&&n>-1){u.GROUP_CURRENTLY_SWITCHING.hasOwnProperty(n)&&delete u.GROUP_CURRENTLY_SWITCHING[n]}}return t}},u.switchGroupInCurrentWindow=async function(e){let t,o;try{const n=await browser.windows.getLastFocused();let i=!0;return t=p(a.a.getGroupFromGroupId(e)),a.a.isWindowAlreadyRegistered(n.id)&&(o=p(a.a.getGroupFromGroupId(a.a.getGroupIdInWindow(n.id))),await a.a.detachWindow(n.id,{fireEvent:!1}),i=!1),await u.openGroupInWindow(e,n.id,{forceClosing:i}),d(t),o&&d(o),n.id}catch(e){r.a.error(e,{args:arguments,snapNewGroup:t,snapOldGroup:o})}},u.switchGroupInCurrentWindow=u.decoratorCurrentlyChanging(u.switchGroupInCurrentWindow),u.closeWindowFromGroupId=async function(e){try{let t=a.a.getWindowIdFromGroupId(e);try{await browser.windows.remove(t)}finally{await a.a.detachWindow(t)}}catch(e){r.a.error(e,{args:arguments})}},u.closeGroup=async function(e,{close_window:t=!1}={}){try{let o=a.a.getGroupIndexFromGroupId(e);if(!a.a.isGroupIndexInOpenWindow(o))return;let n=a.a.getWindowIdFromGroupId(e);const c=await browser.windows.getLastFocused();if(t=t||c.id!==n){if(!s.a.options.pinnedTab.sync){let e=(await browser.tabs.query({windowId:n,pinned:!0})).map(e=>e.id);e.length&&await browser.tabs.move(e,{windowId:c.id,index:0})}await u.closeWindowFromGroupId(e)}else await a.a.detachWindowFromGroupId(e),await i.a.removeTabsInWindow(n,{openBlankTab:!0});return"WindowManager.closeGroup done!"}catch(e){r.a.error(e,{args:arguments})}},u.selectGroup=async function(e,{newWindow:t=!1}={}){try{let o,n=a.a.getGroupIndexFromGroupId(e);return a.a.isGroupIndexInOpenWindow(n)?(o=a.a.groups[n].windowId,await browser.windows.update(o,{focused:!0})):o=t?await u.openGroupInNewWindow(e):await u.switchGroupInCurrentWindow(e),o}catch(e){r.a.error(e,{args:arguments})}},u.selectNextGroup=async function({direction:e=1,open:t=!1,refGroupId:o=-1}={}){try{let n,i=-1;if(-1===o){const t=await browser.windows.getLastFocused();a.a.isWindowAlreadyRegistered(t.id)?(o=a.a.getGroupIdInWindow(t.id),n=a.a.getGroupIndexFromGroupId(o)):n=e>0?-1:0}else n=a.a.getGroupIndexFromGroupId(o);let s=Object(c.a)(a.a.groups),d=s.indexOf(n);for(let o=0;o<s.length-1;o++){let o=s[d=(d+s.length+e)%s.length];if(a.a.groups[o].windowId===browser.windows.WINDOW_ID_NONE&&!t){i=a.a.groups[o].id;break}if(a.a.groups[o].windowId!==browser.windows.WINDOW_ID_NONE&&t){i=a.a.groups[o].id;break}}if(-1===i){let o="Can't "+(t>0?"focus":"switch")+" to "+(e>0?"next":"previous")+" Group",n="Reason: there is no other "+(t>0?"opened":"closed")+" groups";return browser.notifications.create({type:"basic",iconUrl:browser.extension.getURL("/share/icons/tabspace-active-64.png"),title:o,message:n,eventTime:4e3}),"WindowManager.selectNextGroup not done because "+n}return await u.selectGroup(i),i}catch(e){return r.a.error(e,{args:arguments}),-1}},u.removeGroup=async function(e=-1){try{if(-1===e){const t=await browser.windows.getLastFocused();if(!a.a.isWindowAlreadyRegistered(t.id))return browser.notifications.create({type:"basic",iconUrl:browser.extension.getURL("/share/icons/tabspace-active-64.png"),title:"No group removed.",message:"Reason: there is no group in your current window",eventTime:4e3}),"WindowManager.removeGroup done because there is no group in current window.";e=a.a.getGroupIdInWindow(t.id)}let t=a.a.getGroupIndexFromGroupId(e);return a.a.isGroupIndexInOpenWindow(t)&&await u.closeGroup(e),await a.a.removeGroupFromId(e),"WindowManager.removeGroup done on groupId "+e}catch(e){r.a.error(e,{args:arguments})}},u.openGroupInNewWindow=async function(e){let t;try{let o=a.a.getGroupIndexFromGroupId(e);u.WINDOW_EXCLUDED.opening=!0,t=await browser.windows.create({state:"maximized",incognito:a.a.groups[o].incognito});let i=0;for(;!(await browser.windows.get(t.id)).focused;){if(i>50)throw Error("WindowManager.openGroupInNewWindow was unable to focus the window.");i++,await n.a.wait(100)}return await u.switchGroupInCurrentWindow(e),delete u.WINDOW_EXCLUDED.opening,t.id}catch(e){r.a.error(e,{args:arguments}),delete u.WINDOW_EXCLUDED.opening}},u.setWindowPrefixGroupTitle=async function(e,t){if(n.a.hasWindowTitlePreface())try{if(e===browser.windows.WINDOW_ID_NONE)return;await browser.windows.update(e,{titlePreface:"["+n.a.getGroupTitle(t)+"] "})}catch(e){r.a.error(e,{args:arguments})}},u.associateGroupIdToWindow=async function(e,t){try{if(a.a.setLastAccessed(t,Date.now()),n.a.hasWindowTitlePreface()&&s.a.options.groups.showGroupTitleInWindow){let o=a.a.groups[a.a.getGroupIndexFromGroupId(t,{error:!1})];u.setWindowPrefixGroupTitle(e,o)}return n.a.hasSessionWindowValue()&&await browser.sessions.setWindowValue(e,u.WINDOW_GROUPID,t.toString()),"WindowManager.associateGroupIdToWindow done"}catch(e){r.a.error(e,{args:arguments})}},u.isWindowIdOpen=async function(e){try{return(await browser.windows.getAll()).filter(t=>t.id===e).length>0}catch(e){r.a.error(e,{args:arguments})}},u.desassociateGroupIdToWindow=async function(e){try{if(!await u.isWindowIdOpen(e))return;return n.a.hasWindowTitlePreface()&&s.a.options.groups.showGroupTitleInWindow&&browser.windows.update(e,{titlePreface:" "}),n.a.hasSessionWindowValue()&&await browser.sessions.removeWindowValue(e,u.WINDOW_GROUPID),"WindowManager.desassociateGroupIdToWindow done"}catch(e){r.a.error(e,{args:arguments})}},u.addGroupFromWindow=async function(e,{title:t=""}={}){const o=await i.a.getTabsInWindowId(e),n=await browser.windows.get(e);let r=a.a.addGroupWithTab(o,{windowId:e,incognito:n.incognito,title:t});return await u.associateGroupIdToWindow(e,r),r},u.integrateWindowWithTabsComparaison=async function(e,{even_new_one:t=s.a.options.groups.syncNewWindow}={}){const o=await i.a.getTabsInWindowId(e);let n=a.a.bestMatchGroup(o),r=-1;return n>0&&(await a.a.attachWindowWithGroupId(n,e),r=n),r},u.integrateWindowWithSession=async function(e,{even_new_one:t=s.a.options.groups.syncNewWindow}={}){const o=await browser.sessions.getWindowValue(e,u.WINDOW_GROUPID);let n=-1;return void 0!==o&&-1!==a.a.getGroupIndexFromGroupId(parseInt(o,10),{error:!1})&&(await a.a.attachWindowWithGroupId(parseInt(o,10),e),n=parseInt(o,10)),n},u.integrateWindow=async function(e,{even_new_one:t=s.a.options.groups.syncNewWindow,title:o=""}={}){try{const r=await browser.windows.get(e);if("normal"!==r.type)return-1;if(!s.a.options.privateWindow.sync&&r.incognito&&!t)return-1;let a;return-1===(a=n.a.hasSessionWindowValue()?await u.integrateWindowWithSession(e,{even_new_one:t}):await u.integrateWindowWithTabsComparaison(e,{even_new_one:t}))&&(t||s.a.options.privateWindow.sync&&r.incognito)&&(a=await u.addGroupFromWindow(e,{title:o})),a}catch(t){if(u.isErrorWindowNotExists(t,e))return-1;throw t}},u.isErrorWindowNotExists=function(e,t){return!(!e.message.includes("No window with id")&&!e.message.includes("Invalid window ID"))&&(r.a.warning("The window to integrate doesn't exist any more.",{windowId:t}),!0)},t.a=u},9:function(e,t,o){"use strict";var n={};o.r(n),o.d(n,"updateTabsInGroup",function(){return b}),o.d(n,"getTabsInWindowId",function(){return f});var r={};o.r(r),o.d(r,"getTabFactory",function(){return h}),o.d(r,"secureIndex",function(){return T}),o.d(r,"waitTabsToBeClosed",function(){return E}),o.d(r,"countPinnedTabs",function(){return m});var a={};o.r(a),o.d(a,"moveTabToNewGroup",function(){return O}),o.d(a,"moveUnFollowedTabToNewGroup",function(){return _}),o.d(a,"moveUnFollowedTabToGroup",function(){return v}),o.d(a,"moveTabBetweenGroups",function(){return y}),o.d(a,"moveOpenTabToGroup",function(){return G});var i={};o.r(i),o.d(i,"removeTabs",function(){return W}),o.d(i,"removeTabsInWindow",function(){return k});var s={};o.r(s),o.d(s,"openListOfTabs",function(){return D}),o.d(s,"openTab",function(){return C});var c={};o.r(c),o.d(c,"undiscardAll",function(){return U});var u={};o.r(u),o.d(u,"activeTabInWindow",function(){return A}),o.d(u,"changePinState",function(){return R}),o.d(u,"selectTab",function(){return L});var d=o(2),p=o(5),l=o(4),w=o(1),g=o(8);async function f(e,{withoutRealUrl:t=!0,withPinned:o=p.a.options.pinnedTab.sync,hidden:n=!d.a.hasHideFunction()&&void 0}={}){let r={windowId:e};void 0!==n&&(r.hidden=n),o||(r.pinned=!1);let a=await browser.tabs.query(r);return t&&a.forEach(e=>{e.url=d.a.extractTabUrl(e.url),e.hasOwnProperty("isArticle")&&void 0===e.isArticle&&(e.isArticle=!1)}),a.forEach(e=>{e.sharingState&&delete e.sharingState}),a}async function b(e){try{if(g.a.WINDOW_CURRENTLY_SWITCHING[e])return"Doesn't update the groups while it is changed by the extension.";if(g.a.WINDOW_CURRENTLY_CLOSING[e])return"Doesn't update the groups as the window is going to close.";const t=await browser.windows.getAll();let o;for(let n of t)if(n.id===e){o=n;break}if(void 0===o)return".updateTabsInGroup not done for windowId "+e+" because window has been closed";if(!p.a.options.privateWindow.sync&&o.incognito)return".updateTabsInGroup not done for windowId "+e+" because private windows are not synchronized";if(!w.a.isWindowAlreadyRegistered(o.id))return".updateTabsInGroup not done for windowId "+e+" because window is not synchronized";let n=w.a.getGroupIdInWindow(e,{error:!1});if(-1===n)return!1;const r=await f(e);return g.a.WINDOW_CURRENTLY_CLOSING[e]?"Doesn't update the groups as the window is going to close.":(w.a.setTabsInGroupId(n,r),".updateTabsInGroup done on window id "+e)}catch(e){l.a.error(e,{args:arguments})}}var I=o(13);function h(e){return Object.assign({title:"New Tab",url:I.a.NEW_TAB,favIconUrl:"chrome://branding/content/icon32.png",hidden:!1,lastAccessed:0,pinned:!1,windowId:browser.windows.WINDOW_ID_NONE,discarded:!1},e)}function m(e){return e.filter(e=>e.pinned).length}function T(e,t,o){let n=e,r=m(o);return n=-1===(n=t.pinned?n>r||-1===n?r:n:n<r&&n>-1?r:n)?o.length:n}async function E(e,{maxLoop:t=20,waitPerLoop:o=50}={}){Array.isArray(e)||(e=[e]);for(let n=0;n<t;n++){if(await d.a.wait(o),0===(await Promise.all(e.map(async e=>{try{return await browser.tabs.get(e),!0}catch(e){return!1}}))).filter(e=>e).length)return!0}return!1}async function G(e,t,o=-1){try{const n=await browser.tabs.query({windowId:t});!p.a.options.pinnedTab.sync&&o>-1&&(o+=m(n));let r=T(o,e,n);return e.windowId===t&&r>e.index&&r--,await browser.tabs.move(e.id,{index:r,windowId:t}),"moveOpenTabToGroup done!"}catch(e){l.a.error(e,{args:arguments})}}async function y(e,t,o,n=-1){try{let r=w.a.getGroupIndexFromGroupId(o),a=w.a.getGroupIndexFromGroupId(e),i=w.a.groups[a].tabs[t],s=w.a.isGroupIndexInOpenWindow(a),c=w.a.isGroupIndexInOpenWindow(r);return e===o&&(t===n||n===t+1||t===w.a.groups[a].tabs.length-1&&-1===n)?"moveTabBetweenGroups done!":(s&&c?await G(i,w.a.groups[r].windowId,n):(e===o&&n>-1&&n<t&&t++,await w.a.moveTabBetweenGroups(i,e,t,o,n)),"moveTabBetweenGroups done!")}catch(e){l.a.error(e,{args:arguments})}}async function v(e,t){try{let o=w.a.getGroupIdFromTabId(e,!1);if(o>=0){let n=w.a.getGroupIndexFromGroupId(o),r=w.a.getTabIndexFromTabId(e,n,{error:!0});await y(o,r,t)}else{let o=w.a.getGroupIndexFromGroupId(t),n=w.a.isGroupIndexInOpenWindow(o);const r=await browser.tabs.get(e);n?await G(r,w.a.groups[o].windowId,-1):(await w.a.addTabInGroupId(t,r),await browser.tabs.remove(e))}return"moveUnFollowedTabToGroup done!"}catch(e){l.a.error(e,{args:arguments})}}async function O(e,t,o=""){try{let n=w.a.getGroupIndexFromGroupId(e),r=w.a.groups[n].tabs[t],a=w.a.addGroupWithTab([r],{title:o});return await w.a.removeTabFromIndexInGroupId(e,t),a}catch(e){return l.a.error(e,{args:arguments}),-1}}async function _(e){try{const t=await browser.tabs.get(e);let o=w.a.addGroupWithTab([t]);return await browser.tabs.remove(e),o}catch(e){return l.a.error(e,{args:arguments}),-1}}var N=o(15);async function W(e,{forceClosing:t=!1}={}){try{let o=d.a.getCopy(e);if(p.a.isClosingHidden()&&!t){const e=await Promise.all(o.map(e=>N.a.hideTab(e)));if(o.filter((t,o)=>e[o]).forEach(e=>w.a.setTabIsHidden(e,!0)),0===(o=o.filter((t,o)=>!e[o])).length)return}await browser.tabs.remove(o),await E(o)}catch(e){}}async function k(e,{openBlankTab:t=!1,remove_pinned:o=p.a.options.pinnedTab.sync,forceClosing:n=!1}={}){try{let n=await f(e,{withoutRealUrl:!1,withPinned:!0}),r=void 0;if(!t||!o&&n[0].pinned)!o&&n[0].pinned?await browser.tabs.update(n[0].id,{active:!0}):r=n.shift();else if(r=(await D([],e,{inLastPos:!0,openAtLeastOne:!0}))[0],1===n.length&&r.id===n[0].id)return r;void 0!==r&&await browser.tabs.update(r.id,{active:!0});let a=n.filter(e=>o||!e.pinned);return a=a.map(e=>e.id),await browser.tabs.remove(a),await E(a),r}catch(e){l.a.error(e,{args:arguments})}}async function C(e,t,o,n){if(p.a.isClosingHidden()){if(await N.a.showTab(e.id,t,o))return e.active&&await browser.tabs.update(e.id,{active:!0}),await browser.tabs.get(e.id)}let r=e.url,a=!0;d.a.isChrome()&&(a=!(await browser.windows.get(t)).incognito),d.a.isPrivilegedURL(r)&&a&&(r=d.a.getPrivilegedURL(e.title,r,e.favIconUrl)),p.a.options.groups.discardedOpen&&!e.active&&a&&(r=d.a.getDiscardedURL(e.title,r,e.favIconUrl)),"about:privatebrowsing"!==r&&r!==I.a.NEW_TAB||(r=void 0);let i={url:r,active:e.active,pinned:e.pinned,index:o,windowId:t};return e.hasOwnProperty("openerTabId")&&void 0!==n&&n.hasOwnProperty(e.openerTabId)&&(i.openerTabId=n[e.openerTabId]),await browser.tabs.create(i)}async function D(e,t,{inLastPos:o=!1,openAtLeastOne:n=!1,forceOpenNewTab:r=!1,pendingTab:a,remove_pinned:i=p.a.options.pinnedTab.sync,forceClosing:s=!1}={}){try{if(null==t)throw new Error("Impossible to compute openListOfTabs: windowId is null.");if(0===e.length){if(!n)return[];e.push({url:I.a.NEW_TAB,active:!0,pinned:!1})}const c=await f(t,{withoutRealUrl:!1,withPinned:!0}),u=e=>e===I.a.NEW_TAB||"about:blank"===e;if(1===e.length&&u(e[0].url)&&!r){const e=c.filter(e=>!e.pinnded);if(1===e.length&&u(e[0].url))return c}let d=[],p={},w=0,g=0;g=i?0:m(c),w=o?c.length:g;let b=0,h=e.reduce((e,t,o)=>t.active?o:e,-1),T=c.filter(e=>i||!e.pinned);if(h>=0){let o=e[h];d[h]=await C(o,t,w),p[o.id]=d[h].id}for(let o of e){if(b!==h){let e=o.pinned?g:w;d[b]=await C(o,t,e,p),p[o.id]=d[b].id}else o.pinned&&await browser.tabs.move(p[o.id],{index:g});a&&(a=void 0,await W(T.map(e=>e.id),{forceClosing:s})),o.pinned&&g++,w++,b++}if(h>=0){let t=e[h];t.hasOwnProperty("openerTabId")&&p.hasOwnProperty(t.openerTabId)&&browser.tabs.update(p[t.id],{openerTabId:p[t.openerTabId]})}return d}catch(e){l.a.error(e)}}async function U(e=0,t){return new Promise(async function(o,n){let r=Promise.resolve(),a=!1;(await browser.tabs.query({})).forEach(async e=>{r=r.then(async function(){if(e.url.includes(d.a.LAZY_PAGE_URL)){a=!0;try{await browser.tabs.update(e.id,{url:d.a.extractTabUrl(e.url)}),t&&(t(),t=void 0),await d.a.wait(300);let o=0;for(;"loading"===(await browser.tabs.get(e.id)).status&&o<30;)await d.a.wait(300),o++;"complete"===(await browser.tabs.get(e.id)).status&&await browser.tabs.discard(e.id)}catch(e){}}})}),r.then(function(t){a&&e<10?o(U(++e)):o()})})}async function A(e,t){try{let o=(await f(e,{withoutRealUrl:!1})).filter((e,o)=>o===t).map(e=>e.id);return o.length&&await browser.tabs.update(o[0],{active:!0}),"activeTabInWindow done!"}catch(o){l.a.error(o,{args:{windowId:e,tabIndex:t}})}}async function L(e,t,o=!1){try{let n=w.a.getGroupIndexFromGroupId(t);if(w.a.isGroupIndexInOpenWindow(n)){let t=w.a.groups[n].windowId;await A(t,e)}else w.a.groups[n].tabs.forEach(e=>{e.active=!1}),w.a.groups[n].tabs[e].active=!0;return o&&!w.a.isGroupIndexInOpenWindow(n)?await g.a.openGroupInNewWindow(t):await g.a.selectGroup(t),"selectTab done!"}catch(e){l.a.error(e,{args:arguments})}}async function R(e,t){try{let o=w.a.getGroupIndexFromGroupId(e),n=w.a.groups[o].tabs[t];return w.a.isGroupIndexInOpenWindow(o)?await browser.tabs.update(n.id,{pinned:!n.pinned}):(n.pinned=!n.pinned,await w.a.removeTabFromIndexInGroupId(e,t),await w.a.addTabInGroupId(e,n,n.pinned?-1:0)),"changePinState done!"}catch(e){l.a.error(e,{args:arguments})}}function P(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}const S=function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},n=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),n.forEach(function(t){P(e,t,o[t])})}return e}({},n,a,s,i,c,u,r);window.TabManager=S;t.a=S}});